//> This file is part of Ymacs, an Emacs-like editor for the Web
//> http://www.ymacs.org/
//>
//> Copyright (c) 2009-2012, Mihai Bazon, Dynarch.com.  All rights reserved.
//>
//> Redistribution and use in source and binary forms, with or without
//> modification, are permitted provided that the following conditions are
//> met:
//>
//>     * Redistributions of source code must retain the above copyright
//>       notice, this list of conditions and the following disclaimer.
//>
//>     * Redistributions in binary form must reproduce the above copyright
//>       notice, this list of conditions and the following disclaimer in
//>       the documentation and/or other materials provided with the
//>       distribution.
//>
//>     * Neither the name of Dynarch.com nor the names of its contributors
//>       may be used to endorse or promote products derived from this
//>       software without specific prior written permission.
//>
//> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER “AS IS” AND ANY
//> EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
//> IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
//> PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE
//> FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
//> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
//> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
//> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
//> THE POSSIBILITY OF SUCH DAMAGE.
function Ymacs_Exception(a){this.message=a}DEFINE_CLASS("Ymacs",DlLayout,function(a,b,c){function d(a,b){var c,d;if(a.length>0){c=a.peek().getPos().x,d=[a.pop()];while(a.length>0&&a.peek().getPos().x==c)d.push(a.pop());return d.minElement(function(a){return Math.abs(b.y-a.getPos().y-a.getSize().y/2)})}}function e(a,b){var c,d;if(a.length>0){c=a.peek().getPos().y,d=[a.pop()];while(a.length>0&&a.peek().getPos().y==c)d.push(a.pop());return d.minElement(function(a){return Math.abs(b.x-a.getPos().x-a.getSize().x/2)})}}function f(){if(!window.localStorage||!window.localStorage.getItem)throw new Ymacs_Exception("Local storage facility not available in this browser")}a.DEFAULT_EVENTS=["onBufferSwitch","onCreateBuffer","onDeleteBuffer"],a.DEFAULT_ARGS={buffers:["buffers",null],frames:["frames",null],cf_lineNumbers:["lineNumbers",!1],_focusable:["focusable",!0]},a.FIXARGS=function(a){a.buffers||(a.buffers=[]),a.frames||(a.frames=[])},a.CONSTRUCT=function(){var a;this.buffers.foreach(function(a){a.ymacs=this,this._addBufferListeners(a)},this),this.killRing=[],this.killMasterOfRings=[],this.progress={},this.minibuffer=this.createBuffer({hidden:!0,isMinibuffer:!0}),this.minibuffer.cmd("minibuffer_mode"),this.minibuffer_frame=this.createFrame({isMinibuffer:!0,buffer:this.minibuffer,hidden:!0,highlightCurrentLine:!1,className:"Ymacs_Minibuffer"}),this.buffers.length==0&&this.createBuffer(),a=this.createFrame({buffer:this.buffers[0]}),this.packWidget(this.minibuffer_frame,{pos:"bottom"}),this.packWidget(a,{pos:"top",fill:"*"}),this.setActiveFrame(a),a._redrawCaret()},b._addBufferListeners=function(a){var b=this;a.addEventListener("onDestroy",function(){var c=b.getActiveFrame();b.getBufferFrames(a).foreach(function(a){a!==c&&b.deleteFrame(a)}),b.buffers.length>1?b.getActiveBuffer()===a&&b.switchToNextBuffer():b.switchToBuffer(b.createBuffer()),b.buffers.remove(a)})},b.pushToKillRing=function(a,b){b?this.killRing.unshift(a):this.killRing.push(a)},b.killRingToMaster=function(){this.killRing.length&&(this.killMasterOfRings.length==0||this.killMasterOfRings.peek().join("")!=this.killRing.join(""))&&this.killMasterOfRings.push(this.killRing),this.killRing=[]},b.killRingText=function(){return this.killRing.join("")},b.rotateKillRing=function(a){a?(this.killMasterOfRings.push(this.killRing),this.killRing=this.killMasterOfRings.shift()):(this.killMasterOfRings.unshift(this.killRing),this.killRing=this.killMasterOfRings.pop())},b.getBuffer=function(a){return a instanceof Ymacs_Buffer||(a=this.buffers.grep_first(function(b){return b.name==a})),a},b.killBuffer=function(a){a=this.getBuffer(a),this.callHooks("onDeleteBuffer",a),a.destroy()},b.renameBuffer=function(a,b){a=this.getBuffer(a),a.name=b,a.callHooks("onProgressChange")},b._do_switchToBuffer=function(a){this.getActiveFrame().setBuffer(a),this.callHooks("onBufferSwitch",a)},b.switchToBuffer=function(a){var b=this.getBuffer(a),c=this.buffers;return b||(b=this.createBuffer({name:a})),c.remove(b),c.unshift(b),this._do_switchToBuffer(b),b},b.switchToNextBuffer=function(){var a,b=this.buffers;b.length>1&&(a=b.shift(),b.push(a),this._do_switchToBuffer(b[0]))},b.switchToPreviousBuffer=function(){var a,b=this.buffers;b.length>1&&(a=b.pop(),b.unshift(a),this._do_switchToBuffer(a))},b.getNextBuffer=function(a,b){var c;return b==null&&(b=1),c=this.buffers,c[c.rotateIndex(c.find(a)+b)]},b.getPrevBuffer=function(a,b){var c;return b==null&&(b=1),c=this.buffers,c[c.rotateIndex(c.find(a)-b)]},b.getBufferFrames=function(a){return a=this.getBuffer(a),this.frames.grep(function(b){return b.buffer===a})},b.createBuffer=function(a){var b;return a||(a={}),Object.merge(a,{ymacs:this}),b=new Ymacs_Buffer(a),this._addBufferListeners(b),a.hidden||this.buffers.push(b),this.callHooks("onCreateBuffer",b),b},b.createFrame=function(a){var b;return a||(a={}),Object.merge(a,{ymacs:this}),b=new Ymacs_Frame(a),a.hidden||this.frames.unshift(b),b.addEventListener("onDestroy",function(a){this.frames.remove(a)}.$(this,b)),b},b.keepOnlyFrame=function(a){var b;if(this.frames.length>1){b=a.parent;while(b.parent!=this)b=b.parent;this.replaceWidget(b,a),b.destroy(),this.setActiveFrame(a),this.doLayout()}},b.deleteFrame=function(a){var b,d;if(this.frames.length>1){b=a.parent,d=b.children().grep_first(function(b){return b instanceof DlLayout||b instanceof Ymacs_Frame&&b!==a}),b._resizeBar&&(b._resizeBar._widget=d),b.parent.replaceWidget(b,d),b.destroy();try{c.walk(d.getElement(),function(a){a=DlWidget.getFromElement(a);if(a&&a instanceof Ymacs_Frame)throw a})}catch(e){if(!(e instanceof Ymacs_Frame))throw e;d=e}this.setActiveFrame(d),this.doLayout()}},b.focusOtherFrame=function(){this.setActiveFrame(this.frames[0])},b.focus=function(){a.BASE.focus.apply(this,arguments),this.frames.peek().focus()},b.setActiveFrame=function(a,b){var c;a.isMinibuffer||(c=this.getActiveFrame(),c&&c.delClass("Ymacs_Frame-active"),this.frames.remove(a),this.frames.push(a)),b||a.focus()},b.getActiveFrame=function(){return this.frames.peek()},b.getActiveBuffer=function(){var a=this.getActiveFrame();return a?a.buffer:this.buffers.peek()},b.setColorTheme=function(a){this.delClass(/Ymacs-Theme-[^\s]*/g),a instanceof Array||(a=[a]),a.foreach(function(a){this.addClass("Ymacs-Theme-"+a)},this)},b.getFrameInDirection=function(a,b,d){var e,f,g;return d||(d=this.getActiveFrame()),e=d.getCaretElement(),b||(b=c.getPos(e)),b.sz||(b.sz=c.getOuterSize(e)),f=this.frames.mergeSort(function(a,b){return a.getPos().x-b.getPos().x}),g=this.frames.mergeSort(function(a,b){return a.getPos().y-b.getPos().y}),this["_get_frameInDir_"+a](f,g,b,d)},b._get_frameInDir_left=function(a,b,c,e){return a=a.grep(function(a){var b=a.getPos(),d=a.getSize();return a!==e&&b.x<c.x&&b.y-c.sz.y<=c.y&&b.y+d.y>c.y}),d(a,c)},b._get_frameInDir_right=function(a,b,c,e){return a.reverse(),a=a.grep(function(a){var b=a.getPos(),d=a.getSize();return a!==e&&b.x>c.x&&b.y-c.sz.y<=c.y&&b.y+d.y>c.y}),d(a,c)},b._get_frameInDir_up=function(a,b,c,d){return b=b.grep(function(a){var b=a.getPos(),e=a.getSize();return a!==d&&b.y<c.y&&b.x-c.sz.x<=c.x&&b.x+e.x>c.x}),e(b,c)},b._get_frameInDir_down=function(a,b,c,d){return b.reverse(),b=b.grep(function(a){var b=a.getPos(),e=a.getSize();return a!==d&&b.y>c.y&&b.x-c.sz.x<=c.x&&b.x+e.x>c.x}),e(b,c)},b.ls_get=function(){return f(),DlJSON.decode(localStorage.getItem(".ymacs")||"{}",!0)},b.ls_set=function(a){f(),localStorage.setItem(".ymacs",DlJSON.encode(a))},b.ls_getFileContents=function(a,b){var c,d=this.ls_getFileDirectory(a),e=d.other;e.length==1&&(c=d.dir[e[0]]);if(c==null&&!b)throw new Ymacs_Exception("File not found");return c},b.ls_setFileContents=function(a,b){var c=this.ls_getFileDirectory(a,"file");c.dir[c.other[0]]=b,this.ls_set(c.store)},b.ls_getFileDirectory=function(a,b){var c,d,e,f,g,h=c=this.ls_get();a=a.replace(/^[~\x2f]+/,"").split(/\x2f+/),d=[],e=[];while(a.length>0)f=a.shift(),h.hasOwnProperty(f)&&typeof h[f]!="string"?(h=h[f],d.push(f)):e.push(f);if(b){g=b=="file"?1:0;while(e.length>g)h=h[e.shift()]={};this.ls_set(c)}return{store:c,dir:h,path:d,other:e}}}),function(){function j(a,b){var c=i[a]||d[a]||f[a];return c?b?c[1]:c[0]:null}var a,b,c,d,e,f,g,h,i={};for(a=65;a<=90;++a)i[a]=[a,a+32];i[32]=[32,32],b=[16,17,18,20,144].toHash(!0),c=[[49,33],[50,64],[51,35],[52,36],[53,37],[54,94],[55,38],[56,42],[57,40],[48,41]],d=[49,50,51,52,53,54,55,56,57,48].toHash(function(a,b){return c[b]}),e=[[59,58],[61,43],[44,60],[45,95],[46,62],[47,63],[96,126],[91,123],[92,124],[93,125],[39,34]],f=(is_gecko?[59,61,188,109,190,191,192,219,220,221,222]:is_opera?[59,61,44,45,46,47,96,91,92,93,39]:[186,187,188,189,190,191,192,219,220,221,222]).toHash(function(a,b){return e[b]}),g=[37,38,39,40].toHash(!0),h=[45,46,36,35,33,34,112,113,114,115,116,117,118,119,120,121,122,123].toHash(!0),window.KEYBOARD_INSANITY={letters:i,modifiers:b,digits:d,symbols:f,arrows:g,specials:h,getCharCode:j}}(),window.Ymacs_Regexp=function(){function b(a){var b,c;return a instanceof RegExp&&(a=a+""),b=a.lastIndexOf("/"),c="",c=a.substr(b+1),a=a.substring(1,b),{pattern:a,flags:c}}var a={};return{search_backward:function(c){var d=c+"",e=a[d];return e||(c=b(d),c.flags=c.flags.replace(/g/g,"")+"g",e=RegExp("([^]*)("+c.pattern+")",c.flags),a[d]=e),e.lastIndex=0,e}}}(),DEFINE_CLASS("Ymacs_Frame",DlContainer,function(a,b,c){function l(a,b,c){function f(a){var g,h,i,j;for(g=a.firstChild;g;g=g.nextSibling)if(g.nodeType==3){h=g.length;if(d+h>b)throw i=b-d,j=g.splitText(i),a.insertBefore(c,j),e;if(d+h==b)throw a.insertBefore(c,g.nextSibling),e;d+=h}else g.nodeType==1&&f(g)}var d,e;if(/^br$/i.test(a.firstChild.tagName))return a.insertBefore(c,a.firstChild),c;d=0,e={};try{f(a)}catch(g){if(g===e)return c;throw g}}function m(){e=null}function n(a){var b=a.computePos(this.getContentElement()),c=this.coordinatesToRowCol(b.x,b.y);this.buffer.cmd("goto_char",this.buffer._rowColToPosition(c.row,c.col)),this.buffer.ensureTransientMark(),this.ensureCaretVisible()}function o(){DlEvent.releaseGlobals(this._dragSelectCaptures)}var d,e,f,g,h=300,i=DlException.stopEventBubbling,j=c.createElement("div",null,{className:"line",innerHTML:"<br/>"}),k=225;a.DEFAULT_EVENTS=["onPointChange"],a.DEFAULT_ARGS={highlightCurrentLine:["highlightCurrentLine",!0],buffer:["buffer",null],ymacs:["ymacs",null],isMinibuffer:["isMinibuffer",!1],_focusable:["focusable",!0],_fillParent:["fillParent",!0]},a.CONSTRUCT=function(){var a;this.__blinkCaret=this.__blinkCaret.$(this),this.__caretId=Dynarch.ID(),this.redrawModelineWithTimer=this.redrawModeline.clearingTimeout(0,this),this.getElement().innerHTML=d,this.addEventListener({onDestroy:this._on_destroy,onFocus:this._on_focus,onBlur:this._on_blur,onMouseDown:this._on_mouseDown,onKeyDown:this._on_keyDown,onKeyPress:this._on_keyPress,onKeyUp:this._on_keyUp,onResize:this._on_resize.clearingTimeout(5)}),this._dragSelectCaptures={onMouseOver:i,onMouseOut:i,onMouseEnter:i,onMouseLeave:i,onMouseMove:n.$(this),onMouseUp:o.$(this)},this._bufferEvents={onLineChange:this._on_bufferLineChange.$(this),onInsertLine:this._on_bufferInsertLine.$(this),onDeleteLine:this._on_bufferDeleteLine.$(this),onPointChange:this._on_bufferPointChange.$(this),onResetCode:this._on_bufferResetCode.$(this),onOverwriteMode:this._on_bufferOverwriteMode.$(this),onProgressChange:this._on_bufferProgressChange.$(this),beforeInteractiveCommand:this._on_bufferBeforeInteractiveCommand.$(this),afterInteractiveCommand:this._on_bufferAfterInteractiveCommand.$(this),onOverlayDelete:this._on_bufferOverlayDelete.$(this)},this._moreBufferEvents={onMessage:this._on_bufferMessage.$(this),onOverlayChange:this._on_bufferOverlayChange.$(this),afterInteractiveCommand:this.ensureCaretVisible.$(this)},a=this.buffer,this.buffer=null,a&&this.setBuffer(a),!this.isMinibuffer&&this.ymacs.cf_lineNumbers&&this.toggleLineNumbers()},d=String.buffer("<div class='Ymacs-frame-overlays'>","<div class='Ymacs-frame-content'></div>","</div>","<div class='Ymacs_Modeline'></div>").get(),b.focus=function(b){a.BASE.focus.call(this),b instanceof Function&&(this.removeEventListener("onBlur",this.__exitFocusHandler),this.addEventListener("onBlur",this.__exitFocusHandler=function(){b.call(this.buffer)?this.removeEventListener("onBlur",this.__exitFocusHandler):this.focus.delayed(2,this,null)}))},b.blur=function(b){b&&this.removeEventListener("onBlur",this.__exitFocusHandler),a.BASE.blur.call(this)},b.getOverlaysContainer=function(){return this.getElement().firstChild},b.getModelineElement=function(){return this.getElement().childNodes[1]},b.getContentElement=function(){return this.getElement().firstChild.firstChild},b.getCaretElement=function(){return document.getElementById(this.__caretId)},b.getLineDivElement=function(a){return this.getContentElement().childNodes[a]||null},b.ensureCaretVisible=function(){var a,b,c,d,e;return this._redrawCaret(),a=!1,b=this.getCaretElement(),b?(c=this.getOverlaysContainer(),d=this.getLineDivElement(this.buffer._rowcol.row),e=d.offsetTop+d.offsetHeight-(c.scrollTop+c.clientHeight),e>0?(c.scrollTop+=e,a=!0):(e=d.offsetTop-c.scrollTop,e<0&&(c.scrollTop+=e,a=!0)),e=b.offsetLeft+b.offsetWidth-(c.scrollLeft+c.clientWidth),e>0?(c.scrollLeft+=e,a=!0):(e=b.offsetLeft-c.scrollLeft,e<0&&(c.scrollLeft+=e,a=!0)),a):a},b.setBuffer=function(a){this.buffer&&(this.caretMarker&&!this.isMinibuffer&&(this.caretMarker.destroy(),this.caretMarker=null),this.buffer.removeEventListener(this._bufferEvents),this.buffer.removeEventListener(this._moreBufferEvents)),this.buffer=a,a&&(this.buffer.addEventListener(this._bufferEvents),this.focusInside()&&a.addEventListener(this._moreBufferEvents),this.isMinibuffer?this.caretMarker=a.caretMarker:this.caretMarker=a.createMarker(a.caretMarker.getPosition()),this._redrawBuffer(),this._redrawCaret(!0),this.centerOnCaret())},b.centerOnCaret=function(){this.centerOnLine(this.buffer._rowcol.row)},b.centerOnLine=function(a){var b=this.getLineDivElement(a),c=this.getOverlaysContainer();c.scrollTop=Math.round(b.offsetTop-c.clientHeight/2+b.offsetHeight/2)},b.setModelineContent=function(a){this.getModelineElement().innerHTML=a},b.deleteOtherFrames=function(){this.ymacs.keepOnlyFrame(this)},b.deleteFrame=function(){this.ymacs.deleteFrame(this)},b.vsplit=function(a){var b,c,d,e;a==null&&(a="50%"),b=this.parent,c=this.ymacs.createFrame({buffer:this.buffer}),d=new DlLayout,e=new DlResizeBar({widget:this,keepPercent:!0,horiz:!0,className:"Ymacs-splitbar-horiz"}),this._resizeBar&&(this._resizeBar._widget=d,d._resizeBar=this._resizeBar),this._resizeBar=e,b.replaceWidget(this,d),d.packWidget(this,{pos:"top",fill:a}),d.packWidget(e,{pos:"top"}),d.packWidget(c,{pos:"top",fill:"*"}),b.__doLayout(),c.centerOnCaret()},b.hsplit=function(a){var b,c,d,e;a==null&&(a="50%"),b=this.parent,c=this.ymacs.createFrame({buffer:this.buffer}),d=new DlLayout,e=new DlResizeBar({widget:this,keepPercent:!0,className:"Ymacs-splitbar-vert"}),this._resizeBar&&(this._resizeBar._widget=d,d._resizeBar=this._resizeBar),this._resizeBar=e,b.replaceWidget(this,d),d.packWidget(this,{pos:"left",fill:a}),d.packWidget(e,{pos:"left"}),d.packWidget(c,{pos:"left",fill:"*"}),b.__doLayout(),c.centerOnCaret()},b.toggleLineNumbers=function(){this.condClass(this.__lineNumbers=!this.__lineNumbers,"Ymacs-line-numbers")},b.setMarkerAtPos=function(a,b){a.tagName||(a=this.getLineDivElement(a));if(a)return l(a,b,c.createElement("span"))},b.__restartBlinking=function(){this.__stopBlinking(),this.focusInside()&&(this.__caretTimer=setTimeout(this.__blinkCaret,2*k))},b.__stopBlinking=function(){clearTimeout(this.__caretTimer),this.__showCaret()},b.__blinkCaret=function(){c.condClass(this.getCaretElement(),this.BLINKING=!this.BLINKING,"Ymacs-caret"),this.__caretTimer=setTimeout(this.__blinkCaret,k)},b.__showCaret=function(){c.addClass(this.getCaretElement(),"Ymacs-caret")},b._unhoverLine=function(){this.__hoverLine!=null&&(c.delClass(this.getLineDivElement(this.__hoverLine),"Ymacs-current-line"),this.__hoverLine=null)},b._redrawCaret=function(a){var b,d=this.ymacs.getActiveFrame()===this;if(!a&&!d)return;d&&!this.isMinibuffer&&this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),b=this.buffer._rowcol,this.highlightCurrentLine&&(this._unhoverLine(),c.addClass(this.getLineDivElement(b.row),"Ymacs-current-line"),this.__hoverLine=b.row),Array.$(this.getElement().querySelectorAll(".Ymacs-caret, #"+this.__caretId)).foreach(function(a){a.id="",a.className=""}),this.__prevCaretLine!=null&&this._on_bufferLineChange(this.__prevCaretLine),this.__prevCaretLine!=b.row&&(this.__prevCaretLine=b.row,this._on_bufferLineChange(b.row)),d&&this.__restartBlinking(),this.callHooks("onPointChange",b.row,b.col),this.redrawModelineWithTimer(b)},b._getLineHTML=function(a){var b=this.buffer.formatLineHTML(a,this.caretMarker),c=b.indexOf("Ymacs-caret'>");return c>=0&&(b=b.substr(0,c+12)+" id='"+this.__caretId+"'"+b.substr(c+12)),b},b._redrawBuffer=function(){this.setContent(this.buffer.code.map(function(a,b){return this._getLineHTML(b).htmlEmbed("div","line")},this).join(""))},b.coordinatesToRowCol=function(a,b){function f(a,d){var e,g,h,i;return a==d?a:(e=Math.floor((a+d)/2),g=c.getLineDivElement(e),h=g.offsetTop,i=h+g.offsetHeight-1,i<b?f(e+1,d):b<h?f(a,e-1):e)}function g(b,e){var f,h,i;return b==e?b:(f=Math.floor((b+e)/2),h=c.coordinates(d,f),i=c.coordinates(d,f+1),i.x<a?g(f+1,e):a<h.x?g(b,f-1):f)}var c,d,e;return c=this,d=f(0,this.buffer.code.length-1),e=g(0,this.buffer.code[d].length),{row:d,col:e}},b.coordinates=function(a,b){var d=this.getLineDivElement(a),e=this.setMarkerAtPos(d,b),f={x:e.offsetLeft,y:d.offsetTop,h:d.offsetHeight};return c.trash(e),f},b.heightInLines=function(){return Math.floor(this.getOverlaysContainer().clientHeight/this.getContentElement().firstChild.offsetHeight)},b.setOuterSize=b.setSize=function(b){a.BASE.setOuterSize.apply(this,arguments),c.setOuterSize(this.getOverlaysContainer(),b.x,b.y-this.getModelineElement().offsetHeight),c.setOuterSize(this.getModelineElement(),b.x)},b.redrawModeline=function(a){this.setModelineContent(this.buffer.renderModelineContent(a||this.caretMarker.getRowCol()))},b._on_bufferLineChange=function(a){var b=this.getLineDivElement(a);b&&(b.innerHTML=this._getLineHTML(a))},b._on_bufferInsertLine=function(a,b){var c=j.cloneNode(!0);this.getContentElement().insertBefore(c,this.getLineDivElement(a)),b&&(c.innerHTML=this._getLineHTML(a))},b._on_bufferDeleteLine=function(a){c.trash(this.getLineDivElement(a))},b._on_bufferPointChange=function(){this._redrawCaret()},b._on_bufferResetCode=function(){this._redrawBuffer()},b._on_bufferOverwriteMode=function(a){this.condClass(a,"Ymacs-overwrite-mode")},b._on_bufferMessage=function(a,b,c,d){var e=this.isMinibuffer?this.ymacs:this,f=Ymacs_Message_Popup.get(0);f.popup({content:c?b:b.htmlEscape(),widget:e,anchor:e.getElement(),align:{prefer:"CC",fallX1:"CC",fallX2:"CC",fallY1:"CC",fallY2:"CC"}}),f.hide(d||5e3)},b._on_bufferBeforeInteractiveCommand=function(){this._unhoverLine(),Ymacs_Message_Popup.clearAll()},b._on_bufferAfterInteractiveCommand=function(){},b._on_bufferProgressChange=function(){this.redrawModelineWithTimer(null)},b.getOverlayId=function(a){return this.id+"-ovl-"+a},b.getOverlayHTML=function(a,b){var c,d,e,f;return b.line1==b.line2&&b.col1==b.col2?(this._on_bufferOverlayDelete(a,b),null):(c=this.coordinates(b.line1,b.col1),d=this.coordinates(b.line2,b.col2),e=this.__lineNumbers?this.coordinates(b.line1,0):{x:0,y:0},c.x-=e.x,d.x-=e.x,f=String.buffer("<div id='",this.getOverlayId(a),"' class='Ymacs_Overlay ",a,"' style='top:",c.y,"px;left:",e.x,"px'>"),b.line1==b.line2?f("<div class='",a,"' style='margin-left:",c.x,"px; width:",d.x-c.x,"px;height:",d.h,"px;'>&nbsp;</div>"):(f("<div class='",a,"' style='margin-left:",c.x,"px;height:",c.h,"px;'>&nbsp;</div>"),b.line2-b.line1>1&&f("<div class='",a,"' style='height:",d.y-c.y-c.h,"px'></div>"),f("<div class='",a,"' style='width:",d.x,"px;height:",d.h,"px;'>&nbsp;</div>")),f("</div>"),f.get())},b.getOverlaysCount=function(){return this.getOverlaysContainer().childNodes.length-1},b._on_bufferOverlayChange=function(a,b,d){var e,f,g=this.getOverlayHTML(a,b);g&&(g=c.createFromHtml(g),e=this.getOverlaysContainer(),f=!d&&$(this.getOverlayId(a)),f?e.replaceChild(g,f):e.appendChild(g))},b._on_bufferOverlayDelete=function(a){c.trash($(this.getOverlayId(a)))},b._on_destroy=function(){this.setBuffer(null),this.__stopBlinking()},b._on_focus=function(){window.focus(),this.ymacs.setActiveFrame(this,!0),this.addClass("Ymacs_Frame-active"),this.isMinibuffer||this.buffer.cmd("goto_char",this.caretMarker.getPosition()),this.buffer.addEventListener(this._moreBufferEvents),this.__restartBlinking()},b._on_blur=function(){this.isMinibuffer||this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),this.buffer.removeEventListener(this._moreBufferEvents),this.__stopBlinking()},e=0,f=null,g=null,b._on_mouseDown=function(a){var b,c,d;clearTimeout(f),e++,f=m.delayed(h),this.__restartBlinking(),b=a.computePos(this.getContentElement()),c=this.coordinatesToRowCol(b.x,b.y),d=this.buffer,d.clearTransientMark(),d.cmd("goto_char",d._rowColToPosition(c.row,c.col)),d.callInteractively("keyboard_quit"),e==1?(d.ensureTransientMark(),DlEvent.captureGlobals(this._dragSelectCaptures)):e==2?(d.cmd("backward_word"),d.cmd("forward_word_mark")):e==3?(d.cmd("beginning_of_line"),d.cmd("end_of_line_mark")):e==4&&(d.cmd("backward_paragraph"),d.cmd("forward_whitespace"),d.cmd("beginning_of_line"),d.cmd("forward_paragraph_mark")),i()},b._on_keyDown=function(a){var b,c;if(!is_gecko){b=window.KEYBOARD_INSANITY,c=a.keyCode,c in b.modifiers&&i();if((c in b.letters||c in b.digits||c in b.symbols)&&!a.ctrlKey&&!a.altKey)return;a.charCode=b.getCharCode(c,a.shiftKey),a.charCode&&(a.keyCode=0),this.buffer._handleKeyEvent(a)&&i()}},b._on_keyPress=function(a){is_gecko||(a.keyCode=0),this.buffer._handleKeyEvent(a)&&i()},b._on_keyUp=function(){},b._on_resize=function(){this.destroyed||this.centerOnCaret()}}),DEFINE_CLASS("Ymacs_Message_Popup",DlPopup,function(a){a.FIXARGS=function(a){a.focusable=!1,a.autolink=!1,a.zIndex=5e3}}),DEFINE_CLASS("Ymacs_Text_Properties",DlEventProxy,function(a,b){a.DEFAULT_EVENTS=["onChange"],a.DEFAULT_ARGS={buffer:["buffer",null]},a.CONSTRUCT=b.reset=function(){this.props=[]},b.insertLine=function(a){this.props.length<a?this.props[a]=null:this.props.splice(a,0,null)},b.deleteLine=function(a){this.props.splice(a,1)},b.replaceLine=function(a,b){var c=this.props[a];c&&c.length>b.length&&c.splice(b.length,c.length)},b.addLineProps=function(a,b,c,d,e){var f,g=this.props,h=!1;if(b<c){g=g[a]||(g[a]=[]);while(b<c)f=g[b]||(g[b]={}),f[d]!=e&&(h=!0),f[d]=e,++b;h&&this.callHooks("onChange",a)}return h},b.removeLineProps=function(a,b,c,d){var e,f=this.props[a],g=!1;if(f&&b<c){while(b<c)e=f[b],e&&d in e&&(g=!0,delete e[d]),++b;g&&this.callHooks("onChange",a)}return g},b.getLineHTML=function(a,b,c){var d,e,f,g,h,i,j=this.props[a];if(c===null){if(b=="")return"<br/>";if(!j||j.length==0)return b.htmlEscape()}else{if(b=="")return"<span class='Ymacs-caret'>&nbsp;</span>";if(!j||j.length==0)return c===b.length?b.htmlEscape()+"<span class='Ymacs-caret'>&nbsp;</span>":b.substr(0,c).htmlEscape()+"<span class='Ymacs-caret'>"+b.charAt(c).htmlEscape()+"</span>"+b.substr(c+1).htmlEscape()}d=0,e=b.length,f=null,h="";while(d<e){g=j[d],g=g&&g.css,d===c&&(g=g?g+" Ymacs-caret":"Ymacs-caret"),g&&g!=f?(f&&(h+="</span>"),h+="<span class='"+g+"'>"):!g&&f&&(h+="</span>"),f=g,i=b.charAt(d);switch(i){case"<":h+="&lt;";break;case">":h+="&gt;";break;case"&":h+="&amp;";break;default:h+=i}++d}return f&&(h+="</span>"),d===c&&(h+="<span class='Ymacs-caret'>&nbsp;</span>"),h}}),function(){function c(a){var b=this.getPrefixArg(!0);b&&(a=b+" "+a),this.cmd("minibuffer_prompt",a)}function d(a,b){c.call(this,a),this.cmd("minibuffer_read_function",b)}function e(a,b){c.call(this,a),this.cmd("minibuffer_read_buffer",b)}function f(a,b){c.call(this,a),this.cmd("minibuffer_read_buffer",b)}function g(){}function h(a,b){c.call(this,a),this.cmd("minibuffer_read_command",b)}function i(a,b){b.call(this,this.point())}function j(){}function k(a,b){b.call(this,null)}function l(){}function m(){}function n(a,b){b.call(this,this.markMarker.getPosition())}function o(a,b){c.call(this,a),this.cmd("minibuffer_read_string",null,b)}function p(a,b){c.call(this,a),this.cmd("minibuffer_read_number",b)}function q(a,b){var c=parseInt(this.getPrefixArg(),10);isNaN(c)?p.call(this,a,b):b.call(this,c)}function r(a,b){var c=parseInt(this.getPrefixArg(),10);isNaN(c)&&(c=null),b.call(this,c)}function s(b,c){b=this.getPrefixArg(),b===""&&(b=a),c.call(this,b)}function t(a,b){var c=this.getRegion();b.call(this,c.begin,c.end)}function u(){}function v(a,b){c.call(this,a),this.cmd("minibuffer_read_variable",b)}function w(a,b){c.call(this,a),this.cmd("minibuffer_read_existing_file",b)}function x(a,b){c.call(this,a),this.cmd("minibuffer_read_file",b)}function y(a,b){c.call(this,a),this.cmd("minibuffer_read_file_or_directory",b)}function z(a,b){c.call(this,a),this.cmd("minibuffer_read_directory",b)}function A(a,c){var d=a.charAt(0);return a=a.substr(1),b[d].$(null,a,c)}var a,b;window.Ymacs_Interactive=function(a,b){var c,d,e,f;arguments.length==1?(b=a,a=null):b instanceof Function||(c=b,b=arguments[2],b.ymacsDoc=c),b.ymacsInteractive=!0;if(a instanceof Function)b.ymacsGetArgs=a;else if(a!=null){a instanceof Array||(d=/^[\^\@\*]+/.exec(a),d&&(d=d[0],a=a.substr(d.length),d.indexOf("^")>=0&&(b.ymacsMarkExtend=!0),d.indexOf("*")>=0&&(b.ymacsWarnReadonly=!0),d.indexOf("@")>=0&&(b.ymacsSelectFrame=!0)),a&&(a=a.split(/\n+/)));if(a){f=function(){return e.append(Array.$(arguments)),this.callInteractively(b,e,!0)};while(a.length>0)f=A(a.pop(),function(a){e.append(Array.$(arguments,1)),a.call(this)}.$(null,f));b.ymacsCallInteractively=function(){return e=[],f.call(this)}}}return b},window.Ymacs_Interactive_X=function(a){return Ymacs_Interactive("p",function(b){b==null&&(b=1),b.times(a,this)})},a=function(){},a.toString=function(){return""},a.empty=!0,b={a:d,b:e,B:f,c:g,C:h,d:i,e:j,i:k,k:l,K:m,m:n,M:o,n:p,N:q,p:r,P:s,r:t,s:o,U:u,v:v,f:w,F:x,G:y,D:z}}(),DEFINE_CLASS("Ymacs_Buffer",DlEventProxy,function(a,b){function g(a,b){var c,d;if(typeof a=="string")return b===undefined?delete this[a]:this[a]=b,b instanceof Function&&(b.ymacsCommand=a),b;c={};for(d in a)c[d]=this[d],g.call(this,d,a[d]);return c}function h(a){return a instanceof Ymacs_Marker?a.getPosition():a}function i(a){var b;if(a)return b=a.charCodeAt(0),b>=48&&b<=57||a.toUpperCase()!=a.toLowerCase()}function j(a){var b;if(a)return b=a.charCodeAt(0),b>=48&&b<=57||a=="_"||a.toUpperCase()!=a.toLowerCase()}var c,d,e,f;a.DEFAULT_EVENTS=["onLineChange","onInsertLine","onDeleteLine","onPointChange","onResetCode","onMessage","onOverwriteMode","onOverlayChange","onOverlayDelete","beforeInteractiveCommand","afterInteractiveCommand","beforeRedraw","afterRedraw","finishedEvent","onProgressChange","onTextInsert","onTextDelete"],a.DEFAULT_ARGS={name:["name","*scratch*"],_code:["code",null],ymacs:["ymacs",null],tokenizer:["tokenizer",null],isMinibuffer:["isMinibuffer",!1]},c={case_fold_search:!0,line_movement_requested_col:0,fill_column:78,tab_width:8,indent_level:8,syntax_word:{test:i},syntax_word_dabbrev:{test:j},syntax_paragraph_sep:/\n\s*\n/g},d=5e4,b.lastIndexOfRegexp=function(a,b,c,d){var e,f;a=a.substring(0,c),b=Ymacs_Regexp.search_backward(b),b.lastIndex=d||0,e=b.exec(a);if(e)return f=Array.$(e,2),f.index=e.index+e[1].length,f.after=e.index+e[0].length,f[0]=a.substring(f.index,f.after),this.matchData=f,f},a.COMMANDS=b.COMMANDS={},a.newCommands=b.newCommands=function(){return g.apply(this.COMMANDS,arguments)},a.newMode=b.newMode=function(b,c){var d="*"+b+"*",e=d+"hooks";a.setGlobal(e,[]),this.COMMANDS[b]=Ymacs_Interactive("P",function(a){var f,g=this.getq(d);return g?a!==!0&&(this.getq(e).foreach(function(a){a.call(this,!1)},this),g instanceof Function&&g.call(this),this.setq(d,null),this.modes.remove(b)):a!==!1&&(f=c.apply(this,arguments),f instanceof Function||(f=!0),this.setq(d,f),this.modes.push(b),this.getq(e).foreach(function(a){a.call(this,!0)},this)),g})},a.addModeHook=b.addModeHook=function(a,b){var c;typeof b=="string"&&(b=this.COMMANDS[b]),c="*"+a+"*hooks",this.getq(c).pushUnique(b)},a.removeModeHook=b.removeModeHook=function(a,b){var c;typeof b=="string"&&(b=this.COMMANDS[b]),c="*"+a+"*hooks",this.getq(c).remove(b)},a.FIXARGS=function(a){a.code==null&&(a.code="")},a.CONSTRUCT=function(){this.__savingExcursion=0,this.__preventUpdates=0,this.__preventUndo=0,this.__undoInProgress=0,this.__dirtyLines=[],this.__undoQueue=[],this.__redoQueue=[],this.__overlays={},this.markers=[],this.caretMarker=this.createMarker(0,!1,"point"),this.markMarker=this.createMarker(0,!0,"mark"),this.matchData=[],this.previousCommand=null,this.currentCommand=null,this.currentKeys=[],this.progress={},this.variables={},this.globalVariables=c,this.modes=[],this.caretMarker.onChange.push(function(){this._rowcol=this.caretMarker.getRowCol(),this.__preventUpdates==0&&this.callHooks("onPointChange",this._rowcol,this.point())}),this._tokenizerEvents={onFoundToken:this._on_tokenizerFoundToken.$(this)},this._textProperties=new Ymacs_Text_Properties({buffer:this}),this._textProperties.addEventListener("onChange",this._on_textPropertiesChange.$(this)),this.keymap=[],this.pushKeymap(this.makeDefaultKeymap()),this.setCode(this._code),this._lastCommandWasKill=0,delete this._code},b.withVariables=function(a,b){var c,d={};for(c in a)d[c]=this.variables[c],this.variables[c]=a[c];try{return b instanceof Function?b.apply(this,Array.$(arguments,2)):this.cmdApply(b,Array.$(arguments,2))}finally{for(c in d)d[c]===undefined?delete this.variables[c]:this.variables[c]=d[c]}},b.withCommands=function(a,b){var c=this.COMMANDS;this.COMMANDS=Object.makeCopy(c),Object.merge(this.COMMANDS,a);try{return b instanceof Function?b.apply(this,Array.$(arguments,2)):this.cmdApply(b,Array.$(arguments,2))}finally{this.COMMANDS=c}},b.getVariable=function(a){return a in this.variables?this.variables[a]:c[a]},b.setVariable=function(){return g.apply(this.variables,arguments)},a.setq=a.setVariable=a.setGlobal=b.setGlobal=function(){return g.apply(c,arguments)},b.setq=b.setVariable,b.getq=b.getVariable,a.getq=a.getVariable=function(a){return c[a]},b.pushKeymap=function(a){a instanceof Array?a.foreach(this.pushKeymap,this):(this.popKeymap(a),this.keymap.push(a),a.attached(this))},b.popKeymap=function(a){this.keymap.remove(a),a.detached(this)},b.makeDefaultKeymap=function(){return Ymacs_Keymap_Emacs()},b.signalError=function(a,b,c){this.callHooks("onMessage","error",a,b,c)},b.signalInfo=function(a,b,c){this.callHooks("onMessage","info",a,b,c)},b.createMarker=function(a,b,c){return a==null&&(a=this.point()),new Ymacs_Marker({editor:this,pos:a,name:c,before:b})},b.point=function(){return this.caretMarker.getPosition()},b.setCode=function(a){this.__code=a,this.__size=a.length,this.__undoQueue=[],this.__redoQueue=[],this.__overlays={},this.markers.map("setPosition",0,!0,!0),this.code=a.split(/\n/),this._textProperties.reset(),this.tokenizer&&this.tokenizer.reset(),this.callHooks("onResetCode",this.code),this.caretMarker.setPosition(0,!1,!0),this.markMarker.setPosition(0,!0),this.forAllFrames(function(a){a.ensureCaretVisible(),a.redrawModeline()})},b.setTokenizer=function(a){this.tokenizer!=null&&this.tokenizer.removeEventListener(this._tokenizerEvents),this.tokenizer=a,a?a.addEventListener(this._tokenizerEvents):(this._textProperties.reset(),this.callHooks("onResetCode",this.code))},b.getCode=function(){return this.__code||(this.__code=this.code.join("\n"))},b.getCodeSize=function(){var a,b;if(this.__size)return this.__size;a=this.code.length,b=a>0?-1:0;while(--a>=0)b+=this.code[a].length+1;return this.__size=b},b.getLine=function(a){return a==null&&(a=this._rowcol.row),this.code[a]},b.charAtRowCol=function(a,b){var c,d=this.code.length;return a<d--?(c=this.code[a],b==c.length?a==d&&c.charAt(b)||"\n":c.charAt(b)):null},b.charAt=function(a){var b;return a==null?a=this.point():(a=h(a),a<0&&(a+=this.point())),b=this._positionToRowCol(a),this.charAtRowCol(b.row,b.col)},b
.callInteractively=function(a,b,c){var d;b||(b=[]),a instanceof Function?d=a.ymacsCommand||null:(d=a,a=this.COMMANDS[a]);if(a.ymacsCallInteractively&&!c)return a.ymacsCallInteractively.apply(this,b);this.currentCommand=d,d!="undo"&&(this.__undoQueue=this.__undoQueue.concat(this.__redoQueue),this.__redoQueue=[]),this.previousCommand!=d?(this.sameCommandCount(0),d!="undo"&&this._placeUndoBoundary()):(d!="self_insert_command"||this.sameCommandCount()%20==0)&&d!="undo"&&this._placeUndoBoundary(),this.preventUpdates();try{return this.callHooks("beforeInteractiveCommand",d,a),a.ymacsMarkExtend||this.clearTransientMark(),a.apply(this,b)}catch(e){if(!(e instanceof Ymacs_Exception))throw e;this.signalError(e.message)}finally{this.resumeUpdates(),this.callHooks("afterInteractiveCommand",d,a),this.previousCommand=d,this.sameCommandCount(1)}},b.resetOverwriteMode=function(a){arguments.length==0&&(a=this.overwriteMode),this.callHooks("onOverwriteMode",this.overwriteMode=!a),this.signalInfo(a?"Insert mode":"Overwrite mode")},b.getMinibuffer=function(){return this.whenYmacs(function(a){return a.minibuffer})},b.getMinibufferFrame=function(){return this.whenYmacs(function(a){return a.minibuffer_frame})},b.setMinibuffer=function(a){this.whenMinibuffer(function(b){b.setCode(a),b.cmd("end_of_buffer")})},b.cmd=function(a){return this.COMMANDS[a].apply(this,Array.$(arguments,1))},b.cmdApply=function(a,b){return this.COMMANDS[a].apply(this,b)},b.createDialog=function(a){var b;return a.parent||(a.parent=this.getActiveFrame()&&this.getActiveFrame().getParentDialog(),"noShadows"in a||(a.noShadows=!0)),b=new DlDialog(a),this.whenActiveFrame(function(a){b.addEventListener("onDestroy",a.focus.clearingTimeout(0,a))}),b},b.getActiveFrame=function(){return this.whenYmacs("getActiveFrame")},b.when=function(a,b){a=this[a]||this.getq(a);if(a!=null)return b instanceof Function?b.call(this,a):a[b].apply(a,Array.$(arguments,2))},b.whenActiveFrame=function(){var a,b=this.getActiveFrame();if(b.buffer===this)return this.activeFrame=b,a=Array.$(arguments),a.unshift("activeFrame"),this.when.apply(this,a);this.activeFrame=null},b.forAllFrames=function(a){this.ymacs&&this.ymacs.getBufferFrames(this).foreach(a)},b.whenYmacs=function(){var a=Array.$(arguments);return a.unshift("ymacs"),this.when.apply(this,a)},b.whenMinibuffer=function(a){return this.whenYmacs(function(b){if(b.minibuffer)return a.call(this,b.minibuffer)})},b.preventUpdates=function(){++this.__preventUpdates},b.resumeUpdates=function(){(this.__preventUpdates=Math.max(this.__preventUpdates-1,0))==0&&this.redrawDirtyLines()},b.getRegion=function(a,b){var c;return a==null&&(a=this.caretMarker),b==null&&(b=this.markMarker),a=h(a),b=h(b),b<a&&(c=a,a=b,b=c),{begin:a,end:b}},b.redrawDirtyLines=function(){this.callHooks("beforeRedraw"),this.__dirtyLines.foreach(function(a,b){a&&this.callHooks("onLineChange",b)},this),this.__dirtyLines=[],this.callHooks("afterRedraw")},b.getOverlays=function(){return this.__overlays},b.getOverlay=function(a){return this.__overlays[a]},b.setOverlay=function(a,b){var c,d=this.__overlays[a],e=!d;e?d=this.__overlays[a]=b:Object.merge(d,b),d.line2<d.line1?(c=d.line2,d.line2=d.line1,d.line1=c,c=d.col2,d.col2=d.col1,d.col1=c):d.line2==d.line1&&d.col2<d.col1&&(c=d.col2,d.col2=d.col1,d.col1=c),this.callHooks("onOverlayChange",a,d,e)},b.deleteOverlay=function(a){delete this.__overlays[a],this.callHooks("onOverlayDelete",a)},b.ensureTransientMark=function(){var a,b=this._rowcol;this.transientMarker||(this.transientMarker=this.createMarker(),this.markMarker.setPosition(this.point()),a=b),a||(a=this.transientMarker.getRowCol()),this.setOverlay("selection",{line1:a.row,col1:a.col,line2:b.row,col2:b.col})},b.clearTransientMark=function(){this.transientMarker&&(this.transientMarker.destroy(),this.transientMarker=null,this.deleteOverlay("selection"))},b.deleteTransientRegion=function(){if(this.transientMarker)return this._deleteText(this.caretMarker,this.transientMarker),this.clearTransientMark(),this._placeUndoBoundary(),!0},e=0,b.sameCommandCount=function(a){return a==null?e:e+=a},b.interactiveEvent=function(a){return arguments.length==0?f:f=a},b.getPrefixArg=function(a){var b=this.getq("universal_prefix");return a||(this.setq("universal_prefix",undefined),this.isMinibuffer||this.setMinibuffer("")),b},b.setPrefixArg=function(a){return this.setq("universal_prefix",a)},b.updateProgress=function(a,b){b==null?delete this.progress[a]:this.progress[a]=b,this.callHooks("onProgressChange")},b.renderModelineContent=function(a){var b,c,d=String.buffer("-- <b>",this.name.htmlEscape(),"</b> (",a.row+1,",",a.col,") "),e=this.getq("modeline_custom_handler");e&&(e=e.call(this,this,a),e&&d("[",e,"] ")),b=[];for(c in this.progress)b.push(c+": "+this.progress[c]);return b.length>0&&d("{",b.join(", "),"}"),d.get()},b._recordChange=function(a,b,c,e){var f;c>0&&(f=this.__undoQueue,f.push({type:a,pos:b,len:c,text:e}),f.length>d&&f.shift())},b._placeUndoBoundary=function(a){var b,c;a=a||this.__undoQueue,b=this.markers.map(function(a){return[a,a.getPosition()]}),c=a.peek(),!c||c.type!=3?a.push({type:3,markers:b}):c.markers=b},b._playbackUndo=function(a){var b,c,d;++this.__undoInProgress,b=!1;while(a.length>0&&a.peek().type==3)c=a.pop();while(a.length>0){c=a.pop();if(c.type==3){c.markers.foreach(function(a){a[0].setPosition(a[1])});break}b=!0,d=c.pos;switch(c.type){case 1:this._deleteText(d,d+c.len);break;case 2:this._insertText(c.text,d)}}return--this.__undoInProgress,b},b._replaceLine=function(a,b){this.code[a]=b,this._textProperties.replaceLine(a,b),this.__preventUpdates==0?this.callHooks("onLineChange",a):this.__dirtyLines[a]=!0},b._deleteLine=function(a){this.code.splice(a,1),this._textProperties.deleteLine(a),this.tokenizer&&this.tokenizer.quickDeleteLine(a),this.__dirtyLines.splice(a,1),this.callHooks("onDeleteLine",a)},b._insertLine=function(a,b){var c;this.code.splice(a,0,b),this._textProperties.insertLine(a),this.tokenizer&&this.tokenizer.quickInsertLine(a),c=this.__preventUpdates==0,this.callHooks("onInsertLine",a,c),c||(this.__dirtyLines.length>a?this.__dirtyLines.splice(a,0,!0):this.__dirtyLines[a]=!0)},b._insertText=function(a,b){var c,d,e,f,g;if(a.length==0)return;b==null&&(b=this.caretMarker.getPosition()),b=h(b),this.__preventUndo==0&&this._recordChange(1,b,a.length),c=b==this.point()?this._rowcol:this._positionToRowCol(b),d=c.row,/^\n+$/.test(a)&&c.col==0?a.length.times(function(a){this._insertLine(d+a,"")},this):(e=a.split("\n"),f=this.code[d],g=f.substr(c.col),e.length>1?(this._replaceLine(d,f.substr(0,c.col)+e.shift()),e.foreach(function(a){this._insertLine(++d,a)},this),this._replaceLine(d,this.code[d]+g)):this._replaceLine(d,f.substr(0,c.col)+e[0]+f.substr(c.col))),this._updateMarkers(b,a.length),this.callHooks("onTextInsert",b,a)},b._deleteText=function(a,b){var c,d,e,f;a=this._boundPosition(h(a)),b=this._boundPosition(h(b));if(a==b)return;b<a&&(c=a,a=b,b=c),this.__preventUndo==0&&this._recordChange(2,a,b-a,this._bufferSubstring(a,b)),d=this._positionToRowCol(a),e=this._positionToRowCol(b),f=this.code[d.row],d.row==e.row?(f=f.substr(0,d.col)+f.substr(e.col),this._replaceLine(d.row,f)):(f=f.substr(0,d.col)+this.code[e.row].substr(e.col),this._replaceLine(d.row,f),f=d.row+1,(e.row-d.row).times(this._deleteLine.$(this,f))),this._updateMarkers(a,a-b,a),this.callHooks("onTextDelete",a,b)},b._replaceText=function(a,b,c){this._deleteText(a,b),this._insertText(c,a)},b._swapAreas=function(a){var b,c,d,e,f,g;return a=a.map(h).mergeSort(),b=a[0],c=a[1],d=a[2],e=a[3],f=this._bufferSubstring(b,c),g=this._bufferSubstring(d,e),this._replaceText(d,e,f),this._replaceText(b,c,g),e},b._bufferSubstring=function(a,b){var c;return a==null?a=this.point():a=h(a),b==null?b=this.getCodeSize():b=h(b),b<a&&(c=a,a=b,b=c),this.getCode().substring(a,b)},b._killingAction=function(a,b,c,d){var e;a=h(a),b=h(b),e=this._bufferSubstring(a,b),this._saveKilledText(e,c),d||this._deleteText(a,b)},b._saveKilledText=function(a,b){this._lastCommandWasKill||this.ymacs.killRingToMaster(),this.ymacs.pushToKillRing(a,b),this._lastCommandWasKill++},b._positionToRowCol=function(a){var b,c=0,d=this.code,e=d.length;while(a>0&&c<e){b=d[c].length;if(b>=a)break;a-=b+1,c++}return{row:c,col:a}},b._rowColToPosition=function(a,b){var c=0,d=this.code,e=Math.min(a,d.length-1),f=e;if(e<0)return 0;while(--e>=0)c+=d[e].length+1;return c+Math.min(b,d[f].length)},b._boundPosition=function(a){return a<0?0:Math.min(a,this.getCodeSize())},b._repositionCaret=function(a){var b=this.caretMarker.getPosition();return a==null&&(a=b),a=h(a),a=this._boundPosition(a),this.caretMarker.setPosition(a),a!=b},b._updateMarkers=function(a,b,c){this.__size=null,this.__code=null,this.markers.map("editorChange",a,b,c||0),this.tokenizer&&this.tokenizer.quickUpdate(Math.min(a,a+b))},b._saveExcursion=function(a,b){var c=this.createMarker(null,b);++this.__savingExcursion;try{return a.call(this)}finally{--this.__savingExcursion,this.caretMarker.swap(c,!1,!0),c.destroy()}},b._disableUndo=function(a){++this.__preventUndo;try{return a.call(this)}finally{--this.__preventUndo}},b._handleKeyEvent=function(a){var b,c,d,e,f=!1;return this.interactiveEvent(a),b=this._lastCommandWasKill,this.__nextIsMeta&&(a.altKey=!0),this.__nextIsMeta=!1,c=Ymacs_Keymap.unparseKey(a),d=this.currentKeys,e=!1,d.push(c),this.keymap.r_foreach(function(a){var b=a.getHandler(d);b instanceof Array?(this.callInteractively(b[0],b[1]),f=!0):b?f=e=!0:c==="ESCAPE"?(this.__nextIsMeta=!0,f=!0):a.defaultHandler&&d.length==1&&(f=this.callInteractively(a.defaultHandler[0],a.defaultHandler[1])),f&&$BREAK()},this),e||(f||d.length>1&&(this.signalError(d.join(" ").bold()+" is undefined",!0),f=!0),d.splice(0,d.length)),this._lastCommandWasKill==b&&typeof f!="object"&&(this._lastCommandWasKill=0),this.callHooks("finishedEvent",f),this.interactiveEvent(null),f},b._on_tokenizerFoundToken=function(a,b,c,d){d?this._textProperties.addLineProps(a,b,c,"css",d):this._textProperties.removeLineProps(a,b,c,"css")},b._on_textPropertiesChange=function(a){this.__preventUpdates==0?this.callHooks("onLineChange",a):this.__dirtyLines[a]=!0},b.formatLineHTML=function(a,b){var c=this._rowcol;return b instanceof Ymacs_Marker&&(c=b.getRowCol()),b=a==c.row?c.col:null,this._textProperties.getLineHTML(a,this.code[a],b)}}),DEFINE_CLASS("Ymacs_Marker",null,function(a,b){a.DEFAULT_ARGS={position:["pos",null],editor:["editor",null],before:["before",!1],name:["name",null]},a.CONSTRUCT=function(){this.editor.markers.push(this),this.rowcol=null,this.onChange=[]},b.destroy=function(){this.editor.markers.remove(this),this.editor=null},b.editorChange=function(a,b,c){var d=this.position;this.before&&--d,b!=0&&a<=d&&(this.rowcol=null,this.position+=b,this.position<c&&(this.position=c),this.callHooks(this.onChange,this.position))},b.callHooks=function(a,b){var c;for(c=a.length;--c>=0;)a[c].call(this.editor,b)},b.getPosition=function(){return this.position},b.setPosition=function(a,b,c){if(c||this.position!=a)this.rowcol=null,this.position=a,b||this.callHooks(this.onChange,this.position)},b.getRowCol=function(){return this.rowcol||(this.rowcol=this.editor._positionToRowCol(this.position))},b.updateMarkers=function(a){this.editor._updateMarkers(this.getPosition(),a)},b.swap=function(a,b,c){var d=this.getPosition();this.setPosition(a.getPosition(),b,c),a.setPosition(d,b,c)}}),Ymacs_Buffer.newCommands({forward_char:Ymacs_Interactive("p",function(a){return a==null&&(a=1),this.cmd("goto_char",this.point()+a)}),backward_char:Ymacs_Interactive("p",function(a){return a==null&&(a=1),this.cmd("forward_char",-a)}),forward_line:Ymacs_Interactive("p",function(a){var b,c;return a==null&&(a=1),b=this._rowcol,/^(forward|backward)_line$/.test(this.previousCommand)||this.setq("line_movement_requested_col",b.col),c=this.cmd("goto_char",this._rowColToPosition(b.row+a,Math.max(b.col,this.getq("line_movement_requested_col")))),c||this.setq("line_movement_requested_col",b.col),c}),backward_line:Ymacs_Interactive("p",function(a){return a==null&&(a=1),this.cmd("forward_line",-a)}),forward_whitespace:Ymacs_Interactive("P",function(a){var b=a?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_forward_regexp",b))return this.cmd("backward_char"),!0;if(!a)return this.cmd("end_of_buffer")}),backward_whitespace:Ymacs_Interactive("P",function(a){var b=a?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_backward_regexp",b))return this.cmd("forward_char"),!0;if(!a)return this.cmd("beginning_of_buffer")}),beginning_of_line:Ymacs_Interactive(function(){return this.cmd("goto_char",this._rowColToPosition(this._rowcol.row,0))}),back_to_indentation:Ymacs_Interactive(function(){var a=this._rowcol,b=this.code[a.row],c=/\S/.exec(b);if(c)return this.cmd("goto_char",this._rowColToPosition(a.row,c.index))}),beginning_of_indentation_or_line:Ymacs_Interactive(function(){return this.cmd("back_to_indentation")||this.cmd("beginning_of_line")}),end_of_line:Ymacs_Interactive(function(){var a=this._rowcol;return this.cmd("goto_char",this._rowColToPosition(a.row,this.code[a.row].length))}),beginning_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",0)}),end_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",this.getCodeSize())}),eob_p:function(){return this.point()==this.getCodeSize()},bob_p:function(){return this.point()==0},eol_p:function(){var a=this._positionToRowCol(this.point());return a.col==this.code[a.line].length},bol_p:function(){return this._positionToRowCol(this.point()).col==0},backward_delete_char:Ymacs_Interactive("^p",function(a){var b;this.deleteTransientRegion()||(a==null&&(a=1),b=this.point(),b>0&&this._deleteText(b-a,b))}),delete_char:Ymacs_Interactive("^p",function(a){var b;this.deleteTransientRegion()||(a==null&&(a=1),b=this.point(),this._deleteText(b,b+a))}),delete_whitespace:Ymacs_Interactive("^P",function(a){var b;if(!this.deleteTransientRegion()){b=this.point();if(this.cmd("forward_whitespace",a))return this._deleteText(b,this.point()),!0}}),backward_delete_whitespace:Ymacs_Interactive("^P",function(a){var b;if(!this.deleteTransientRegion()){b=this.point();if(this.cmd("backward_whitespace",a))return this._deleteText(this.point(),b),!0}}),delete_indentation:Ymacs_Interactive("P",function(a){a&&this.cmd("forward_line"),this.cmd("back_to_indentation"),this.cmd("backward_delete_whitespace"),this.cmd("insert"," ")}),universal_argument:Ymacs_Interactive("^",function(){this.pushKeymap(Ymacs_Keymap_UniversalArgument()),this.isMinibuffer||this.setMinibuffer("C-u")}),overwrite_mode:Ymacs_Interactive(function(){this.resetOverwriteMode()}),self_insert_command:Ymacs_Interactive("^p",function(a){var b,c,d=this.interactiveEvent(),e=String.fromCharCode(d.charCode),f=this._rowcol;return d.charCode&&e&&!d.altKey&&!d.ctrlKey?(this.deleteTransientRegion(),a!=null&&(e=e.x(a)),this.overwriteMode&&(b=this.code[f.row],c=b.length-f.col,c>0&&this.cmd("delete_char",Math.min(c,a||1))),this.cmd("insert",e),d.domStop=!0,!0):!1}),newline:Ymacs_Interactive("^p",function(a){a==null&&(a=1),this.deleteTransientRegion(),this.cmd("insert","\n".x(a))}),newline_and_indent:Ymacs_Interactive("^p",function(a){a?this.cmd("newline",a):(this.cmd("backward_delete_whitespace",!0),this.cmd("newline"),this.cmd("indent_line"))}),indent_line:Ymacs_Interactive("P",function(a){var b,c;if(this.tokenizer){b=this.tokenizer.getIndentation(this._rowcol.row,this);if(b!=null){if(!a||/\S/.test(this.getLine()))c=this.cmd("save_excursion",function(){return this.cmd("back_to_indentation"),this._rowcol.col!=b&&(this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0),this.cmd("insert"," ".x(b))),this.point()}),this.point()<c&&this.cmd("goto_char",c);return}}this.cmd("insert"," ".x(this.getq("indent_line")))}),indent_region:Ymacs_Interactive("r",function(a,b){var c;b<a&&(c=a,a=b,b=c),this.cmd("save_excursion",function(){var c=this.createMarker(b);this.cmd("goto_char",a);while(this.point()<c.getPosition()){this.cmd("indent_line",!0),this.cmd("beginning_of_line");if(!this.cmd("forward_line"))break}c.destroy()})}),make_marker:function(a){return this.createMarker(a)},looking_at:function(a){var b=a.lastIndex=this.point(),c=this.matchData=a.exec(this.getCode());return c&&(c.after=a.lastIndex),c&&c.index==b},looking_back:function(a){var b=this.lastIndexOfRegexp(this.getCode(),a,this.point());return b&&b.after==this.point()},search_forward:Ymacs_Interactive("sSearch: ",function(a,b){var c,d=this.getCode(),e=this.point();this.getq("case_fold_search")&&(d=d.toLowerCase(),a=a.toLowerCase()),c=d.indexOf(a,e);if(c>=0&&(b==null||c<=b))return this.cmd("goto_char",c+a.length),!0}),search_backward:Ymacs_Interactive("sSearch backward: ",function(a,b){var c,d=this.getCode(),e=this.point();this.getq("case_fold_search")&&(d=d.toLowerCase(),a=a.toLowerCase()),c=d.lastIndexOf(a,e),c==e&&(c=d.lastIndexOf(a,e-1));if(c>=0&&c!=e&&(b==null||c>=b))return this.cmd("goto_char",c),!0}),make_regexp:function(a){var b;if(!(a instanceof RegExp)){b=a.toLowerCase()!=a.toUpperCase();try{a=RegExp(a,b?"ig":"g")}catch(c){throw new Ymacs_Exception("Invalid regexp")}}return a},search_forward_regexp:Ymacs_Interactive("sRegExp search: ",function(a){var b,c,d;a=this.cmd("make_regexp",a),b=this.getCode(),c=a.lastIndex=this.point(),d=this.matchData=a.exec(b);if(d&&a.lastIndex!=c)return d.after=a.lastIndex,this.cmd("goto_char",a.lastIndex),!0}),search_backward_regexp:Ymacs_Interactive("sBackward RegExp search: ",function(a){var b;a=this.cmd("make_regexp",a),b=this.lastIndexOfRegexp(this.getCode(),a,this.point());if(b&&b.index!=this.point())return this.cmd("goto_char",b.index),!0}),forward_word:Ymacs_Interactive_X(function(){var a=this.getq("syntax_word"),b=!1;while(!b&&!a.test(this.charAt()))this.cmd("forward_char")||(b=!0);while(!b&&a.test(this.charAt()))this.cmd("forward_char")||(b=!0)}),backward_word:Ymacs_Interactive_X(function(){var a=this.getq("syntax_word"),b=!1;while(!b&&!a.test(this.charAt(-1)))this.cmd("backward_char")||(b=!0);while(!b&&a.test(this.charAt(-1)))this.cmd("backward_char")||(b=!0)}),forward_paragraph:Ymacs_Interactive_X(function(){this.cmd("forward_whitespace"),this.cmd("search_forward_regexp",this.getq("syntax_paragraph_sep"))?this.cmd("goto_char",this.cmd("match_beginning")+1):this.cmd("end_of_buffer")}),backward_paragraph:Ymacs_Interactive_X(function(){this.cmd("backward_whitespace"),this.cmd("search_backward_regexp",this.getq("syntax_paragraph_sep"))?this.cmd("goto_char",this.cmd("match_end")-1):this.cmd("beginning_of_buffer")}),transpose_words:Ymacs_Interactive_X(function(){var a;this.cmd("backward_char"),this.getq("syntax_word").test(this.charAt())&&this.cmd("forward_word"),a=[],this.cmd("forward_word"),a.push(this.point()),this.cmd("backward_word"),a.push(this.point()),this.cmd("backward_word"),a.push(this.point()),this.cmd("forward_word"),a.push(this.point()),this.cmd("goto_char",this._swapAreas(a))}),transpose_lines:Ymacs_Interactive_X(function(){var a=[];this.cmd("backward_line"),this.cmd("beginning_of_line"),a.push(this.point()),this.cmd("end_of_line"),a.push(this.point()),this.cmd("forward_char"),a.push(this.point()),this.cmd("end_of_line"),a.push(this.point()),this.cmd("goto_char",this._swapAreas(a)+1)}),transpose_chars:Ymacs_Interactive_X(function(){var a=this.point();this.cmd("backward_char")&&this.cmd("goto_char",this._swapAreas([a-1,a,a,a+1]))}),kill_word:Ymacs_Interactive_X(function(){var a,b=this.point();this.cmd("forward_word"),a=this.point(),this._killingAction(b,a,!1)}),backward_kill_word:Ymacs_Interactive_X(function(){var a,b=this.point();this.cmd("backward_word"),a=this.point(),this._killingAction(b,a,!0)}),_apply_operation_on_word:function(a,b){var c,d,e=this.point();this.getq("syntax_word").test(this.charAt())?(c=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()}),d=a.call(this._bufferSubstring(e,c)),this._deleteText(e,c),this._insertText(d)):(this.cmd("forward_word"),this.cmd("backward_word"),e!=this.point()&&this.cmd(b))},capitalize_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",function(){return this.charAt(0).toUpperCase()+this.substr(1).toLowerCase()},"capitalize_word")}),downcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toLowerCase,"downcase_word")}),upcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toUpperCase,"upcase_word")}),goto_char:Ymacs_Interactive("NGoto char: ",function(a){return this._repositionCaret(a)}),goto_line:Ymacs_Interactive("NGoto line: ",function(a){var b=this._rowColToPosition(a-1,0);return this.cmd("goto_char",b)}),move_to_column:Ymacs_Interactive("NMove to column: ",function(a,b){var c=this._positionToRowCol(this.point()),d=this.code[c.row];d.length<a?b?(this.cmd("end_of_line"),this.cmd("insert"," ".x(a-d.length))):this.cmd("end_of_line"):this.cmd("goto_char",this._rowColToPosition(c.row,a))}),delete_region:Ymacs_Interactive("r",function(a,b){this._deleteText(a,b)}),insert:Ymacs_Interactive("sInsert text: ",function(){return this._insertText(Array.$(arguments).join(""))}),keyboard_quit:Ymacs_Interactive("^p",Function.noop),buffer_substring:function(a,b){var c;return arguments.length==0&&(c=this.getRegion(),a=c.begin,b=c.end),this._bufferSubstring(a,b)},kill_line:Ymacs_Interactive_X(function(){var a=this.point(),b=this._rowcol,c=this.code[b.row],d=a+c.length-b.col;b.row<this.code.length-1&&this.cmd("looking_at",/\s*$/mg)&&d++,this._killingAction(a,d)}),save_excursion:function(){return this._saveExcursion.apply(this,arguments)},prevent_undo:function(){return this._disableUndo.apply(this,arguments)},point:function(){return this.caretMarker.getPosition()},kill_region:Ymacs_Interactive("r",function(a,b){this._killingAction(a,b)}),copy_region_as_kill:Ymacs_Interactive("r",function(a,b){this._killingAction(a,b,!1,!0)}),yank:Ymacs_Interactive("^P",function(a){var b;this.deleteTransientRegion(),b=this.point(),this._insertText(this.ymacs.killRingText()),this.cmd("set_mark_command",b),a&&this.cmd("exchange_point_and_mark")}),yank_pop:Ymacs_Interactive(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!1),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),yank_shift:Ymacs_Interactive(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!0),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),mark:function(){return this.markMarker.getPosition()},set_mark_command:Ymacs_Interactive("d",function(a){this.currentCommand=="set_mark_command"&&this.signalInfo("Mark set",null,1e3),this.markMarker.setPosition(a)}),exchange_point_and_mark:Ymacs_Interactive("^",function(){this.caretMarker.swap(this.markMarker)}),mark_whole_buffer:Ymacs_Interactive(function(){this.clearTransientMark(),this.cmd("end_of_buffer"),this.ensureTransientMark(),this.cmd("beginning_of_buffer"),this.ensureTransientMark()}),recenter_top_bottom:Ymacs_Interactive(function(){this.whenActiveFrame(function(a){a.centerOnCaret()})}),ensure_caret_visible:Ymacs_Interactive(function(){this.whenActiveFrame(function(a){a.ensureCaretVisible()&&a.centerOnCaret()})}),fill_paragraph:Ymacs_Interactive("P",function(a){this.cmd("save_excursion",function(){var b,c,d,e;this.cmd("looking_at",this.getq("syntax_paragraph_sep"))||this.cmd("forward_paragraph"),b=this.createMarker(this.point()-1),this.cmd("backward_paragraph"),this.point()>0&&this.cmd("forward_char"),c="",d=!1,this.cmd("looking_at",/\s*([-]|[0-9]+\.|\(?[a-z][\).])?\s+/ig)?(c=" ".x(this.matchData[0].length),d=/\s*[#>;\s]*\s*/g):this.cmd("looking_at",/\s*[#>;*\s]+\s*/g)&&(c=this.matchData[0],d=/\s*[#>;\s]*\s*/g),a&&(this._deleteText(this.point(),this.point()+this.matchData[0].length),c="");for(;;){this.cmd("end_of_line"),this.cmd("backward_delete_whitespace");if(this.point()>=b.getPosition())break;this._replaceText(this.point(),this.point()+1," "),d&&this.cmd("looking_at",d)&&this._deleteText(this.point(),this.point()+this.matchData[0].length)}this.cmd("beginning_of_line");while(this.point()<b.getPosition()){e=this.point();if(!this.cmd("search_forward_regexp",/\s/g))break;this.point()>b.getPosition()&&this.cmd("goto_char",b),this._rowcol.col>this.getq("fill_column")&&(this.cmd("goto_char",e),this.cmd("backward_delete_whitespace"),this.cmd("newline"),this.cmd("insert",c))}b.destroy(),this.cmd("recenter_top_bottom")})}),fill_paragraph_no_prefix:Ymacs_Interactive(function(){return this.cmd("fill_paragraph",!0)}),start_next_paragraph:Ymacs_Interactive(function(){var a;this.cmd("backward_paragraph"),this.point()>0&&this.cmd("forward_char"),a="",this.cmd("looking_at",/(\s*)([0-9]+)(\.\s+)/g)?a=this.matchData[1]+(parseInt(this.matchData[2],10)+1)+this.matchData[3]:this.cmd("looking_at",/(\s*\(?)([a-z])([\.\)]\s+)/ig)?a=this.matchData[1]+String.fromCharCode(this.matchData[2].charCodeAt(0)+1)+this.matchData[3]:this.cmd("looking_at",/\s*[#>;*\s-]+\s*/g)&&(a=this.matchData[0]),this.cmd("forward_paragraph"),this.cmd("eob_p")&&this.cmd("newline"),this.cmd("insert","\n",a),this.cmd("looking_at",/\n\n/g)||(this.cmd("newline"),this.cmd("backward_char"))}),scroll_down:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(a){var b=a.heightInLines();this.cmd("forward_line",Math.round(b/1.33)),this.cmd("recenter_top_bottom")})}),scroll_up:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(a){var b=a.heightInLines();this.cmd("backward_line",Math.round(b/1.33)),this.cmd("recenter_top_bottom")})}),nuke_trailing_whitespace:Ymacs_Interactive(function(){this.cmd("save_excursion",function(){var a,b;this.cmd("goto_char",0);while(this._rowcol.row<this.code.length){a=this.code[this._rowcol.row],b=/\s+$/.exec(a),b&&(this.cmd("beginning_of_line"),this._deleteText(this.point()+b.index,this.point()+a.length));if(!this.cmd("forward_line"))break}})}),match_string:function(a){return this.matchData[a]},match_beginning:function(){return this.matchData.index},match_end:function(){return this.matchData.index+this.matchData[0].length},undo:Ymacs_Interactive_X(function(){var a=this.__undoQueue;this.__undoQueue=this.__redoQueue,this._placeUndoBoundary(),this._playbackUndo(a)||this.signalError("No further undo information"),this.__undoQueue=a}),center_line:Ymacs_Interactive("p",function(a){a==null&&(a=1),a.times(function(a){a>0&&this.cmd("forward_line"),this.cmd("save_excursion",function(){var a,b;this.cmd("end_of_line"),this.cmd("backward_delete_whitespace",!0),this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0),a=this.code[this._rowcol.row],b=Math.floor((this.getq("fill_column")-a.length)/2),this.cmd("insert"," ".x(b))})},this)}),dabbrev_expand:Ymacs_Interactive_X(function(){var a,b,c;this.previousCommand!="dabbrev_expand"&&this.setq("dabbrev_context",null),a=this.getq("dabbrev_context");if(!a){a=this.setq("dabbrev_context",{}),b=this.cmd("save_excursion",function(){return this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"backward_word"),this.point()});if(b==this.point())return this.signalError("Nothing to expand");a.search=this.cmd("buffer_substring",b,this.point()),a.point=b,a.length=this.point()-b,a.lastSearch=b,a.encountered={},a.forward=!1,a.buffer=this,a.startBuffer=this}a.buffer.cmd("save_excursion",function d(){var b,e=this.getq("syntax_word_dabbrev"),f=!1;this.cmd("goto_char",a.lastSearch);if(!a.forward){while(this.cmd("search_backward",a.search))if(!e.test(this.charAt(-1))){f=!0;break}if(!f){a.forward=!0,a.lastSearch=a.point+a.length,d.call(this);return}b=this.point(),a.lastSearch=b,this.cmd("goto_char",b+a.search.length)}else{while(this.cmd("search_forward",a.search))if(!e.test(this.charAt(-a.search.length-1))){f=!0;break}if(!f){a.buffer=this.whenYmacs("getNextBuffer",this);if(a.buffer===a.startBuffer){c=a.search,a.startBuffer.signalError("No more completions"),a.lastSearch=a.point+a.length,a.startBuffer.setq("dabbrev_context",null);return}a.lastSearch=0,a.buffer.cmd("save_excursion",d);return}a.lastSearch=this.point(),b=this.point()-a.search.length}b!=null&&(this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"forward_word"),c=this.cmd("buffer_substring",b,this.point()),Object.HOP(a.encountered,c)&&d.call(this))}),c!=null&&(this._replaceText(a.point,a.point+a.length,c),a.length=c.length,a.encountered[c]=!0)}),split_frame_vertically:Ymacs_Interactive("p",function(a){a==null?a="50%":a+="%",this.whenActiveFrame("vsplit",a)}),split_frame_horizontally:Ymacs_Interactive("p",function(a){a==null?a="50%":a+="%",this.whenActiveFrame("hsplit",a)}),delete_other_frames:Ymacs_Interactive(function(){this.whenActiveFrame("deleteOtherFrames")}),delete_frame:Ymacs_Interactive(function(){this.whenActiveFrame("deleteFrame")}),other_frame:Ymacs_Interactive(function(){this.whenYmacs("focusOtherFrame")}),windmove:function(a){this.whenYmacs(function(b){var c=b.getFrameInDirection(a);c&&c.focus()})},next_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToNextBuffer",this.sameCommandCount()+1)}),previous_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToPreviousBuffer",this.sameCommandCount()+1)}),switch_to_buffer:Ymacs_Interactive("BSwitch to buffer: ",function(a){this.whenYmacs(function(b){b.switchToBuffer(a)})}),kill_buffer:Ymacs_Interactive(function(){this.whenYmacs(function(a){a.killBuffer(this)})}),rename_buffer:Ymacs_Interactive("sRename current buffer to: ",function(a){this.whenYmacs(function(b){b.renameBuffer(this,a)})}),delete_region_or_line:Ymacs_Interactive("^",function(){var a;if(!this.deleteTransientRegion()){this.cmd("beginning_of_line"),a=this.point();if(this.cmd("forward_line")||this.cmd("end_of_line"))return this._deleteText(a,this.point()),!0}}),close_last_xml_tag:Ymacs_Interactive_X(function(){var a;this.cmd("save_excursion",function(){var b=1;while(b!=0&&this.cmd("search_backward_regexp",/<\x2f?([a-zA-Z0-9:_-]+)/g))a=this.cmd("match_string",1),this.cmd("looking_at",/<\x2f/g)?++b:this.cmd("looking_at",/<[^\x2f][^>]*?\x2f>/g)||--b;b!=0&&(a=null)});if(!a)throw new Ymacs_Exception("Couldn't find a tag to close");this.cmd("insert","</",a,">")}),bind_variables:function(){return this.withVariables.apply(this,arguments)},for_region:Ymacs_Interactive("^r\nCExecute command within region: ",function(a,b,c){var d;b<a&&(d=a,a=b,b=d),c instanceof Function||(c=this.COMMANDS[c]),this.clearTransientMark(),this.cmd("goto_char",a),a=this.createMarker(a,!0),b=this.createMarker(b),this.withCommands({goto_char:function(c){if(c<a.getPosition()||c>b.getPosition())throw"YMACS_RESTRICT";return this._repositionCaret(c)}},function(){var d;try{for(;;){d=this.point(),c.call(this);if(this.point()==d&&!this.cmd("forward_line"))break}}catch(e){if(e!=="YMACS_RESTRICT")throw e}finally{a.destroy(),b.destroy()}})})}),function(){function a(a,b,c,d){a.cmd("save_excursion",function(){var a,e,f,g,h,i,j,k=this._positionToRowCol(b),l=this._positionToRowCol(c),m=Math.abs(l.col-k.col);for(a=k.row;a<=l.row;++a)this.cmd("goto_char",this._rowColToPosition(a,0)),e=this.code[a],f=k.col,g=l.col,h=this.point(),i=0,f>g&&(j=f,f=g,g=j),f>e.length&&(i=f-e.length,f=e.length),g>e.length&&(g=e.length),d.call(this,h+f,h+g,i,m)},b==a.point())}Ymacs_Buffer.newCommands({string_rectangle:Ymacs_Interactive("r\nsString rectangle: ",function(b,c,d){a(this,b,c,function(a,b,c){c>0?this._insertText(" ".x(c),a):this._deleteText(a,b),this._insertText(d,a+c)})}),kill_rectangle:Ymacs_Interactive("r",function(b,c){var d=[];a(this,b,c,function(a,b,c,e){var f=this._bufferSubstring(a,b);b-a<e&&(f+=" ".x(e-b+a)),d.push(f),this._deleteText(a,b)}),this.setq("killed_rectangle",d)}),clear_rectangle:Ymacs_Interactive("r",function(a,b){this.cmd("string_rectangle",a,b," ".x(Math.abs(this._positionToRowCol(b).col-this._positionToRowCol(a).col)))}),insert_rectangle:function(a,b){var c=this._positionToRowCol(a).col;this.cmd("set_mark_command",a),b.foreach(function(a,b){b>0&&(this.cmd("forward_line")||(this.cmd("end_of_line"),this.cmd("newline")),this.cmd("move_to_column",c,!0)),this.cmd("insert",a)},this)},yank_rectangle:Ymacs_Interactive("d",function(a){var b=this.getq("killed_rectangle");if(b==null)throw new Ymacs_Exception("No killed rectangle");this.cmd("insert_rectangle",a,b)})})}(),function(){function a(a,b,c,d){var e=this.createDialog({title:b,quitBtn:"destroy",modal:!0}),f=new DlLayout({parent:e,outerSpace:5}),g=new DlEntry({type:"textarea",fillParent:!0,value:c});e._focusedWidget=g,g.addEventListener(a,function(){var a=g.getValue();e.destroy(),d.delayed(0,this,a)}.clearingTimeout(0,this)),f.packWidget(g,{pos:"top",fill:"*"}),f.setSize({x:350,y:250}),e.show(!0),g.select()}Ymacs_Buffer.newCommands({yank_from_operating_system:Ymacs_Interactive(function(){a.call(this,"onPaste","Paste below (press CTRL-V)",null,function(a){this._saveKilledText
(a),this.cmd("yank"),this.cmd("recenter_top_bottom")})}),copy_for_operating_system:Ymacs_Interactive("r",function(b,c){a.call(this,"onCopy","Press CTRL-C",this.cmd("buffer_substring"),function(){this.cmd("copy_region_as_kill",b,c)})}),kill_for_operating_system:Ymacs_Interactive("r",function(b,c){a.call(this,["onCut","onCopy"],"Press CTRL-C or CTRL-X",this.cmd("buffer_substring"),function(){this.cmd("kill_region",b,c)})})})}(),["forward_char","forward_word","forward_line","forward_paragraph","forward_sexp","beginning_of_line","beginning_of_indentation_or_line","beginning_of_buffer","backward_char","backward_word","backward_line","backward_paragraph","backward_sexp","end_of_line","end_of_buffer"].foreach(function(a){Ymacs_Buffer.COMMANDS[a+"_mark"]=Ymacs_Interactive("^",function(){this.ensureTransientMark(),this.cmdApply(a,arguments),this.ensureTransientMark()})}),Ymacs_Buffer.newCommands({get_region:function(){return this.getRegion()},figure_out_mode:function(a){var b=a.split(/\n/);return b.length>4&&b.splice(2,b.length-4),b.foreach(function(a,b){(b=/-\*-\s*(.*?)\s*-\*-/i.exec(a))&&$RETURN(b[1])})},cperl_lineup:Ymacs_Interactive("r",function(a,b){this.cmd("save_excursion",function(){var c,d,e=this._positionToRowCol(b),f=0,g=[];this.cmd("goto_char",a),this.cmd("forward_whitespace",!0),c=this.charAt();if(c.toLowerCase()!=c.toUpperCase()){this.signalError("Cannot lineup here");return}while(this._rowcol.row<=e.row){d=this.getLine().indexOf(c),d>=0&&(d>f&&(f=d),g.push([this._rowcol.row,d]));if(!this.cmd("forward_line"))break}++f,g.foreach(function(a){this.cmd("goto_char",this._rowColToPosition(a[0],a[1])),this.cmd("insert"," ".x(f-a[1]))},this)})}),htmlize_region:Ymacs_Interactive("r\nP",function(a,b,c){var d,e,f,g,h;this.tokenizer.finishParsing(),d=this._positionToRowCol(a).row,e=String.buffer(),f=d,c&&!c.empty&&(f=parseInt(c,10)),b=this._positionToRowCol(b).row,g=(b+"").length;while(d<=b)e("<div class='line'>"),c&&e("<span class='line-number'>",f.zeroPad(g," "),"</span>"),++f,e(this._textProperties.getLineHTML(d,this.code[d],null),"</div>\n"),++d;e=e.get(),h=this.ymacs.switchToBuffer("*Htmlize*"),h.setCode(e),h.cmd("xml_mode",!0)}),execute_extended_command:Ymacs_Interactive("^CM-x ",function(a){this.callInteractively(a)}),set_variable:Ymacs_Interactive("vSet variable: \nsTo value: ",function(a,b){var c=parseFloat(b);isNaN(c)||(b=c),this.setq(a,b)}),eval_string:Ymacs_Interactive("^MEval string: ",function(a){var b;try{b=[this,this.ymacs],a=Function("buffer","ymacs",a),a.apply(this,b),this.clearTransientMark()}catch(c){this.signalError(c.type+": "+c.message),window.console&&console.log(c)}}),eval_region:Ymacs_Interactive("^r",function(a,b){this.cmd("eval_string",this.cmd("buffer_substring",a,b))}),eval_buffer:Ymacs_Interactive(function(){this.cmd("eval_string",this.getCode())}),toggle_line_numbers:Ymacs_Interactive("^",function(){this.whenActiveFrame("toggleLineNumbers")}),save_file:Ymacs_Interactive("FWrite file: ",function(a){this.ymacs.ls_setFileContents(a,this.getCode()),this.signalInfo("Saved in local storage")}),load_file:Ymacs_Interactive("fFind file: ",function(a){var b,c=this.ymacs.ls_getFileContents(a),d=this.ymacs.createBuffer({name:a});d.setCode(c),this.cmd("switch_to_buffer",a),b=this.cmd("figure_out_mode",c),b&&(Object.HOP(d.COMMANDS,b)?d.cmd(b):Object.HOP(d.COMMANDS,b+"_mode")&&d.cmd(b+"_mode"))}),delete_file:Ymacs_Interactive("fDelete file: ",function(a){var b;this.ymacs.ls_getFileContents(a),b=this.ymacs.ls_get(),delete b[a],this.ymacs.ls_set(b)}),eval_file:Ymacs_Interactive("fEval file: ",function(a){this.cmd("eval_string",this.ymacs.ls_getFileContents(a))})}),DEFINE_CLASS("Ymacs_Keymap",null,function(a,b){var c={};Object.foreach(DlKeyboard,function(a,b){typeof a=="number"&&(c[a]=b)}),a.CONSTRUCT=function(){this.definitions=Object.makeCopy(this.__originalDefs)},b.FINISH_OBJECT_DEF=function(){var a;this.__originalDefs={},a=this.constructor.KEYS,a&&this.defineKeys(a)},b.parseKey=function(a){var b,c={},d=a.split(/-/);return d.reverse(),d.foreach(function(a,b){if(b==0)typeof DlKeyboard[a]=="number"?c.keyCode=DlKeyboard[a]:(d[b]=a.toLowerCase(),c.charCode=d[b].charCodeAt(0));else switch(a){case"C":c.ctrlKey=!0;break;case"M":c.metaKey=!0;break;case"S":c.shiftKey=!0}}),d.reverse(),b=d.pop(),c.str=d.sort().join("-"),c.str&&(c.str+="-"),c.str+=b,c},a.unparseKey=function(a){var b,d=[];return a.keyCode in c?b=c[a.keyCode]:a.charCode&&(a.charCode==32?b="SPACE":a.charCode==45?b="DASH":b=String.fromCharCode(a.charCode).toLowerCase()),a.ctrlKey&&d.push("C"),a.altKey&&d.push("M"),a.shiftKey&&(a.charCode&&/^[a-zA-Z0-9]$/.test(b)||a.keyCode)&&d.push("S"),d.sort(),d=d.join("-"),d&&(d+="-"),d+b},b.defineKey=function(a,b,c){var d,e;b instanceof Array&&(c=b.slice(1),b=b[0]),a=a.trim().split(/\s*&&\s*/),a.length>1?a.foreach(function(a){this.defineKey(a,b,c)},this):(a=a[0].trim(),d=this.definitions||this.__originalDefs,a.indexOf(" ")>=0&&(e=a.split(/\s+/),a=e.pop(),e.foreach(function(a){a=this.parseKey(a).str,d[a]||(d[a]={}),d=d[a]},this)),a=this.parseKey(a),d[a.str]=[b,c])},b.defineKeys=function(a){Object.foreach(a,function(a,b){this.defineKey(b,a)},this)},b.getHandler=function(a){var b=null,c=this.definitions;return a.foreach(function(a){var d=b?b[a]:c[a];d?(b=d,b instanceof Array&&$BREAK()):b&&(b=null,$BREAK())}),b},b.attached=Function.noop,b.detached=Function.noop}),DEFINE_SINGLETON("Ymacs_Keymap_Emacs",Ymacs_Keymap,function(a,b){var c=String.template("<table>","<tr><td style='text-align: right; font-weight: bold'>Char:</td><td><tt> $ch </tt></td></tr>","<tr><td style='text-align: right; font-weight: bold'>Char code:</td><td> $code / 0x$codeHex </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Position:</td><td> $point </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Mark:</td><td> $mark </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Buffer size:</td><td> $sizeKB </td></tr>","</table>");a.KEYS={"ARROW_UP     && C-p":"backward_line","ARROW_DOWN   && C-n":"forward_line","ARROW_LEFT   && C-b":"backward_char","ARROW_RIGHT  && C-f":"forward_char",HOME:"beginning_of_indentation_or_line","END && C-e":"end_of_line","C-a":"beginning_of_line","C-HOME && M-<":"beginning_of_buffer","C-END && M->":"end_of_buffer","C-ARROW_RIGHT && M-f":"forward_word","C-ARROW_LEFT && M-b":"backward_word","C-ARROW_DOWN":"forward_paragraph","C-ARROW_UP":"backward_paragraph","C-l":"recenter_top_bottom","PAGE_UP && M-v":"scroll_up","PAGE_DOWN && C-v":"scroll_down","S-ARROW_UP       && S-C-p":"backward_line_mark","S-ARROW_DOWN     && S-C-n":"forward_line_mark","S-ARROW_LEFT     && S-C-b":"backward_char_mark","S-ARROW_RIGHT    && S-C-f":"forward_char_mark","S-C-ARROW_RIGHT  && S-M-f":"forward_word_mark","S-C-ARROW_LEFT   && S-M-b":"backward_word_mark","S-C-ARROW_DOWN":"forward_paragraph_mark","S-C-ARROW_UP":"backward_paragraph_mark","S-HOME":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-END":"end_of_line_mark","S-C-HOME":"beginning_of_buffer_mark","S-C-END":"end_of_buffer_mark",BACKSPACE:"backward_delete_char","DELETE && C-d":"delete_char","ENTER && C-m":"newline","M-d && C-DELETE":"kill_word","C-BACKSPACE && M-BACKSPACE && M-DELETE":"backward_kill_word","C-k":"kill_line","C-y && S-INSERT":"yank","M-y":"yank_pop","C-SPACE":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","C-x C-t":"transpose_lines","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace",TAB:"indent_line","C-M-\\":"indent_region","M-q":"fill_paragraph","C-/ && C-x u && C-_ && C-z":"undo",INSERT:"overwrite_mode","M-s":"center_line","M-/":"dabbrev_expand","C-s":"isearch_forward","C-r":"isearch_backward","M-C-s":"isearch_forward_regexp","M-C-r":"isearch_backward_regexp","C-u":"universal_argument","M-g":"goto_line","C-x h":"mark_whole_buffer","C-g":"keyboard_quit","M-^":"delete_indentation","C-x r t":"string_rectangle","C-x r c":"clear_rectangle","C-x r k":"kill_rectangle","C-x r y":"yank_rectangle","C-x C-ARROW_RIGHT && C-x ARROW_RIGHT && C-TAB":"next_buffer","C-x C-ARROW_LEFT && C-x ARROW_LEFT && C-S-TAB":"previous_buffer","C-x b":"switch_to_buffer","C-x k":"kill_buffer","C-x 0":"delete_frame","C-x 1":"delete_other_frames","C-x 2":"split_frame_vertically","C-x 3":"split_frame_horizontally","C-x o":"other_frame","C-x l":"toggle_line_numbers","M-x":"execute_extended_command","C-S-y":"yank_from_operating_system","M-S-w":"copy_for_operating_system","C-S-w":"kill_for_operating_system","M-S-y":"yank_shift","C-c /":"close_last_xml_tag","S-BACKSPACE":"backward_delete_whitespace","S-DELETE":"delete_whitespace","C-M-d":"delete_region_or_line","M-ENTER":"start_next_paragraph","M-S-q":"fill_paragraph_no_prefix","C-M-|":"cperl_lineup","C-F4":"kill_buffer","M-ARROW_LEFT":["windmove","left"],"M-ARROW_RIGHT":["windmove","right"],"M-ARROW_UP":["windmove","up"],"M-ARROW_DOWN":["windmove","down"],"C-x =":function(){var a=this.charAt(),b=a;a==" "?b="<SPACE>":a=="\n"?b="<NEWLINE>":a=="-"&&(b="<DASH>"),this.signalInfo(c({ch:b.htmlEscape(),code:a.charCodeAt(0),codeHex:a.charCodeAt().hex(),point:this.point(),mark:this.markMarker.getPosition(),size:this.getCodeSize(),sizeKB:this.getCodeSize().formatBytes(2)}),!0)}},b.defaultHandler=["self_insert_command"]}),DEFINE_SINGLETON("Ymacs_Keymap_UniversalArgument",Ymacs_Keymap,function(a,b){b.defaultHandler=[Ymacs_Interactive("^",function(){var a=this.interactiveEvent(),b=String.fromCharCode(a.charCode),c=this.getPrefixArg(!0);return a.charCode&&(/^[0-9]$/.test(b)||b==="-"&&c==="")&&!a.altKey&&!a.ctrlKey?(c+=b,this.setPrefixArg(c),this.isMinibuffer||this.whenMinibuffer(function(a){a.cmd("insert"," ",b)}),!0):(this.popKeymap(Ymacs_Keymap_UniversalArgument()),!1)})],b.attached=function(a){a.setPrefixArg("")}}),DEFINE_SINGLETON("Ymacs_Keymap_ISearch",Ymacs_Keymap,function(a){function b(a){if(!this._isearchContext)return this.pushKeymap(Ymacs_Keymap_ISearch()),this.cmd("set_mark_command",this.point()),this.setMinibuffer(a?"I-Search: ":"I-Search backward: "),this._isearchContext={forward:a,point:this.point(),mbMark:this.getMinibuffer().createMarker(null,!0)},!0}function c(a){var b;return this._isearchContext.forward=a,this._isearchContext.point=this.point(),b=e(this),!/\S/.test(b)&&this.getq("isearch_last_text")&&(this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",this.getq("isearch_last_text")),b=this.getq("isearch_last_text")),d.call(this,b)}function d(a){var b,c;return a==null&&(a=e(this)),b=this.cmd("bind_variables",{case_fold_search:a==a.toLowerCase()},this.cmd,this._isearchContext.forward?"search_forward":"search_backward",a),b&&(this.cmd("ensure_caret_visible"),c=this._positionToRowCol(this.point()+(this._isearchContext.forward?-1:1)*a.length),this.setOverlay("isearch",{line1:c.row,line2:this._rowcol.row,col1:c.col,col2:this._rowcol.col})),b}function e(a){return a.cmd("isearch_get_search_text")}a.KEYS={"C-g && ESCAPE":["isearch_abort",!0],"C-w":"isearch_yank_word_or_char","C-s":"isearch_forward","C-r":"isearch_backward",BACKSPACE:function(){this.getMinibuffer().point()>this._isearchContext.mbMark.getPosition()&&(this.getMinibuffer().cmd("backward_delete_char"),this.cmd("goto_char",this._isearchContext.point),c.call(this,this._isearchContext.forward))},ENTER:"isearch_abort"},a.CONSTRUCT=function(){this.defaultHandler=["isearch_printing_char"]},Ymacs_Buffer.newCommands({isearch_get_search_text:Ymacs_Interactive(function(){if(this._isearchContext)return this.getMinibuffer()._bufferSubstring(this._isearchContext.mbMark)}),isearch_forward:Ymacs_Interactive(function(){b.call(this,!0)||c.call(this,!0)||this.signalError("No more forward occurrences of the search text")}),isearch_forward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward:Ymacs_Interactive(function(){b.call(this,!1)||c.call(this,!1)||this.signalError("No more backward occurrences of the search text")}),isearch_yank_word_or_char:Ymacs_Interactive(function(){var a,b=this.point(),c=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()});c!=b&&(a=this._bufferSubstring(b,c),this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",a.toLowerCase()),a=e(this),this._isearchContext.forward&&this.cmd("goto_char",c-a.length),d.call(this,a))}),isearch_printing_char:Ymacs_Interactive(function(){var a=this.interactiveEvent();if(a.charCode&&!a.ctrlKey&&!a.altKey)return this.getMinibuffer().cmd("self_insert_command"),this.cmd("goto_char",this._isearchContext.point),d.call(this,e(this)),a.domStop=!0;if(a.keyCode!=0||a.ctrlKey||a.altKey)return this.cmd("isearch_abort"),!1}),isearch_abort:Ymacs_Interactive(function(a){return a||this.setGlobal("isearch_last_text",e(this)),this.setMinibuffer(""),this.popKeymap(Ymacs_Keymap_ISearch()),this._isearchContext.mbMark.destroy(),this._isearchContext=null,a&&this.cmd("exchange_point_and_mark"),this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),!0})})}),Ymacs_Buffer.newMode("minibuffer_mode",function(){var a=this.createMarker(0,!0),b=this.setq({minibuffer_end_marker:a}),c=Ymacs_Keymap_Minibuffer();return this.pushKeymap(c),function(){this.setq(b),a.destroy(),this.popKeymap(c)}}),function(){function d(d,e){var f;b&&b.destroy(),b=new DlVMenu({}),e.foreach(function(a){var c=a;typeof a!="string"&&(c=a.completion,a=a.label),new DlMenuItem({parent:b,label:a.htmlEscape(),data:c})}),f=Ymacs_Completion_Popup.get(),f.popup({timeout:0,content:b,align:{prefer:"Tr",fallX1:"_r",fallX2:"_L",fallY1:"B_",fallY2:"T_"},anchor:d.getCaretElement(),widget:d,onHide:function(){a=!1,c=null,b=null},isContext:!0}),a=!0}function e(a,b,c){this.whenMinibuffer(function(d){var e=d.setq({completion_list:a,minibuffer_validation:function(a){return a==null&&(a=d.cmd("minibuffer_contents")),c?c.call(this,d,a):!0}.$(this),minibuffer_continuation:function(a){d.setq(e),b&&b.call(this,a)}.$(this)})})}function f(a,b){var c,e,f,g=this.ymacs.ls_getFileDirectory(b),h=g.dir,i=g.other,j=g.path,k=i[0];if(i.length!=1)throw new Ymacs_Exception("Not found");if(typeof h[k]=="string")return[j.concat([k]).join("/")];c=[];for(e in h)e.indexOf(k)==0&&c.push(e);f=c.common_prefix();if(f!=k)c.length==1&&typeof h[f]!="string"&&(f+="/"),a.cmd("minibuffer_replace_input",j.concat([f]).join("/"));else{if(c.length==1)throw new Ymacs_Exception("Single completion");if(c.length==0)throw new Ymacs_Exception("No completions");c=c.map(function(a){return typeof h[a]!="string"&&(a+="/"),{label:a,completion:j.concat([a]).join("/")}}),d(this.getMinibufferFrame(),c)}return null}function g(a){var d,e=c;switch(a){case"next":c==null&&(c=-1),c=b.children().rotateIndex(++c);break;case"prev":c==null&&(c=0),c=b.children().rotateIndex(--c)}e!=null&&(d=b.children(e),d.callHooks("onMouseLeave")),e=c,d=b.children(c),d.callHooks("onMouseEnter")}function h(){if(a)return g.call(this,"next")}function i(){if(a)return g.call(this,"prev")}function j(){a?c!=null?(this.cmd("minibuffer_replace_input",b.children()[c].userData),DlPopup.clearAllPopups()):this.signalError("Select something..."):this.cmd("minibuffer_complete_and_exit")}function k(){a||this.cmd("minibuffer_complete"),h.call(this)}function l(){i.call(this)}function m(){a?DlPopup.clearAllPopups():this.cmd("minibuffer_keyboard_quit")}var a=!1,b=null,c=null;Ymacs_Buffer.newCommands({minibuffer_prompt:function(a,b){this.whenMinibuffer(function(c){var d=this.getMinibufferFrame();c.setCode(""),c.cmd("prevent_undo",function(){c.cmd("insert",a)}),c.getq("minibuffer_end_marker").setPosition(c.point()),d._redrawCaret(!0),b||d.focus()})},minibuffer_read_number:function(a){e.call(this,null,a,function(a,b){var c=parseInt(b,10);return isNaN(c)&&a.signalError("Please enter a number"),!isNaN(c)})},minibuffer_read_command:function(a){var b=Array.hashKeys(this.COMMANDS).grep(function(a){return this.COMMANDS[a].ymacsInteractive},this).sort();e.call(this,b,a,function(a,b){var c=this.COMMANDS[b],d=c&&c.ymacsInteractive;return d||a.signalError("No such command: "+b),d})},minibuffer_read_function:function(a){var b=Array.hashKeys(this.COMMANDS).sort();e.call(this,b,a,function(a,b){var c=this.COMMANDS[b],d=!!c;return d||a.signalError("No such function: "+b),d})},minibuffer_read_buffer:function(a){this.whenYmacs(function(b){var c=b.buffers.map("name");c.push(c.shift()),e.call(this,c,a),k.call(this)})},minibuffer_read_string:function(a,b){e.call(this,a,b)},minibuffer_read_variable:function(a){var b,c=this.globalVariables;Object.merge(c,this.variables),b=Array.hashKeys(c).grep(function(a){return!/^\*/.test(a)}).sort(),e.call(this,b,a)},minibuffer_read_existing_file:function(a){var b=this.ymacs.ls_getFileDirectory(this.name).path.join("/");b&&(b+="/"),this.cmd("minibuffer_replace_input",b),e.call(this,f,a,function(a,b){var c=this.ymacs.ls_getFileContents(b,!0);return c||a.signalError("No such file: "+b),c})},minibuffer_read_file:function(a){var b=this.ymacs.ls_getFileDirectory(this.name).path.join("/");b&&(b+="/"),e.call(this,f,a)},minibuffer_read_file_or_directory:function(a){var b=this.ymacs.ls_getFileDirectory(this.name).path.join("/");b&&(b+="/"),e.call(this,f,a)},minibuffer_read_directory:function(a){var b=this.ymacs.ls_getFileDirectory(this.name).path.join("/");b&&(b+="/"),e.call(this,f,a)},minibuffer_prompt_end:function(){return this.whenMinibuffer(function(a){return a.getq("minibuffer_end_marker").getPosition()})},minibuffer_contents:function(){return this.whenMinibuffer(function(a){return a._bufferSubstring(a.getq("minibuffer_end_marker"))})},minibuffer_replace_input:function(a){this.whenMinibuffer(function(b){b._replaceText(b.getq("minibuffer_end_marker"),b.getCodeSize(),a),this.getMinibufferFrame()._redrawCaret(!0)})},minibuffer_complete:function(){this.whenMinibuffer(function(a){var b,c=a.getq("completion_list"),e=a.cmd("minibuffer_contents"),f=e.replace(/([\[\]\(\)\{\}\.\*\+\?\|\\])/g,"\\$1").replace(/([_-])/g,"[^_-]*[_-]");f=RegExp("^"+f,"i");if(c instanceof Function){c=c.call(this,a,e,f);if(!c)return}else c&&c.length>0&&(c=c.grep(function(a){return f.test(a)}));!c||c.length==0?a.signalError("No completions"):(b=c.common_prefix(),b!=e?a.cmd("minibuffer_replace_input",b):c.length==1?a.signalError("Sole completion"):d(this.getMinibufferFrame(),c))})},minibuffer_complete_and_exit:function(){this.whenMinibuffer(function(a){a.getq("minibuffer_validation").call(a)&&a.cmd("minibuffer_keyboard_quit",this.getq("minibuffer_continuation"))})},minibuffer_keyboard_quit:function(a){this.whenMinibuffer(function(b){var c=this.cmd("minibuffer_contents");b.setCode(""),this.ymacs.getActiveFrame().focus(),function(b){a&&a.call(this,b),this.getPrefixArg()}.delayed(1,this,c)}),DlPopup.clearAllPopups()}}),DEFINE_SINGLETON("Ymacs_Keymap_Minibuffer",Ymacs_Keymap,function(a,b){a.KEYS={"C-g":"minibuffer_keyboard_quit",TAB:k,"S-TAB":l,ARROW_DOWN:h,ARROW_UP:i,ENTER:j,ESCAPE:m},b.defaultHandler=[function(){return DlPopup.clearAllPopups(),!1}]})}(),DEFINE_CLASS("Ymacs_Completion_Popup",DlCompletionPopup),DEFINE_CLASS("Ymacs_Stream",null,function(a,b){a.DEFAULT_ARGS={buffer:["buffer",null],line:["line",0],col:["col",0]},b.nextCol=function(){++this.col},b.prevCol=function(){--this.col},b.nextLine=function(){++this.line,this.col=0},b.prevLine=function(){--this.line,this.col=0},b.peek=function(a){return a==null&&(a=0),this.buffer.code[this.line].charAt(this.col+a)},b.get=function(){var a=this.peek();return this.nextCol(),a},b.lineText=function(a){return a==null&&(a=this.line),this.buffer.code[a]},b.lineIndentation=function(a){return/^\s*/.exec(this.lineText(a))[0].length},b.lookingAt=function(a){var b=this.buffer.code[this.line];return a instanceof RegExp?a.exec(b.substr(this.col)):b.substr(this.col,a.length)==a},b.textBefore=function(a){return a==null&&(a=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(0,a)},b.textAfter=function(a){return a==null&&(a=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(a)},b.substring=function(a,b){return this.buffer.getCode().substring(a,b)},b.substr=function(a,b){return this.buffer.getCode().substr(a,b)},b.eol=function(){return this.col==this.buffer.code[this.line].length},b.eof=function(){var a=this.buffer.code.length,b=this.line;return b>=a||b==a-1&&this.eol()},b.length=function(){return this.buffer.code.length},b.lineLength=function(a){return a==null&&(a=this.line),this.buffer.code[a].length},b.save=function(){return{buffer:this.buffer,line:this.line,col:this.col}},b.restore=function(a){this.buffer=a.buffer,this.line=a.line,this.col=a.col},b.checkStop=function(){if(this.eof())throw this.EOF;if(this.eol())throw this.EOL},b.EOL=new function(){},b.EOF=new function(){}}),DEFINE_CLASS("Ymacs_Tokenizer",DlEventProxy,function(a,b){var c={};a.define=function(a,b){c[a.toLowerCase()]=b},a.DEFAULT_EVENTS=["onFoundToken"],a.DEFAULT_ARGS={buffer:["buffer",null],type:["type",null]},a.FIXARGS=function(a){typeof a.type=="string"&&(a.type=c[a.type.toLowerCase()])},a.CONSTRUCT=function(){var a=null,b=null;this.quickUpdate=function(c){var d=this.buffer._positionToRowCol(c).row;this.parsers.splice(d-1,this.parsers.length+1),a!=null?a=Math.min(d,a):a=d,clearTimeout(b),b=function(){this._do_quickUpdate(a),a=null}.delayed(1,this)},this._stopQuickUpdate=function(){clearTimeout(b),clearTimeout(this.timerUpdate)},this.reset()},b.reset=function(){this.stream=new Ymacs_Stream({buffer:this.buffer}),this.theParser=this.type(this.stream,this),this.parsers=[],this.parsers[-1]=this.theParser.copy(),this.timerUpdate=null,this.quickUpdate(0)},b.getLanguage=function(a){return c[a](this.stream,this)},b.showProgress=function(a){a!=null&&(a=Math.round(a/this.stream.length()*100)+"%"),this.buffer.updateProgress("Syntax highlighting",a)},b._do_quickUpdate=function(a){var b,c,d,e,f,g,h;this._stopQuickUpdate(),b=this.stream,d=this.parsers,b.line=a-1;while(!(c=d[b.line]))b.prevLine();b.nextLine(),c=c(),f=0,g=!0,h=function(){this.buffer.preventUpdates(),e=100,++f>10&&this.showProgress(this.stream.line);for(;;)try{for(;;)c.next()}catch(a){if(a!==b.EOL){if(a===b.EOF){d[b.line]=c.copy(),this.buffer.resumeUpdates(),c.on_EOF&&c.on_EOF();break}throw a}d[b.line]=c.copy(),b.nextLine();if(--e==0){this.buffer.resumeUpdates(),this.timerUpdate=setTimeout(h,25),g=!1;return}}this.showProgress()}.$(this),h()},b.quickInsertLine=function(a){this.parsers.splice(a,this.parsers.length+1)},b.quickDeleteLine=function(a){this.parsers.splice(a,this.parsers.length+1)},b.onToken=function(a,b,c,d){this.callHooks("onFoundToken",a,b,c,d)},b.getParserForLine=function(a){var b,c,d,e;this._stopQuickUpdate(),b=this.stream,d=this.parsers,e=b.line,b.line=a-1;while(!(c=d[b.line]))b.prevLine();b.nextLine(),c=c();try{this.buffer.preventUpdates();for(;;){if(b.line==a)return c;try{for(;;)c.next()}catch(f){if(f!==b.EOL){if(f===b.EOF)break;throw f}d[b.line]=c.copy(),b.nextLine()}}}finally{this.buffer.resumeUpdates(),b.line<b.length()&&(this.timerUpdate=this._do_quickUpdate.delayed(50,this,b.line))}},b.reparseAll=function(){return this.parsers.splice(0,this.parsers.length),this.finishParsing()},b.finishParsing=function(){return this.getParserForLine(this.stream.length()),this.getLastParser()},b.getLastParser=function(){return this.parsers.peek()},b.getIndentation=function(a,b){var c=this.getParserForLine(a);if(c&&c.indentation instanceof Function)return c.indentation(b)}}),DEFINE_SINGLETON("Ymacs_Keymap_ParenMatch",Ymacs_Keymap,function(a){function c(a,b){return a.line<b.line?-1:a.line>b.line?1:a.col-b.col}function d(){throw new Ymacs_Exception("Balanced expression not found")}function e(a){var b=a.context.passedParens;return b instanceof Function?b():b}var b;a.KEYS={"C-c \\":"goto_matching_paren","C-M-q":"indent_sexp","C-M-f && C-M-n":"forward_sexp","C-M-b && C-M-p":"backward_sexp","C-M-u && M-a && C-M-ARROW_UP":"backward_up_list","M-e":"up_list","C-M-ARROW_DOWN":"down_list","M-C-k":"kill_sexp","M-C-SPACE":"mark_sexp","M-C-t":"transpose_sexps","M-(":["paredit_wrap_round","("],"M-[":["paredit_wrap_round","["],"M-{":["paredit_wrap_round","{"],'M-"':["paredit_wrap_round",'"',!0],"M-'":["paredit_wrap_round","'",!0]},b={"(":")","[":"]","{":"}",'"':{close:'"',backslash:/[\x22\\]/g},"'":{close:"'",backslash:/[\x27\\]/g}},Ymacs_Buffer.newCommands({matching_paren:function(){var a,b=this.tokenizer.getLastParser(),c=this._rowcol;if(b)return a=e(b),a.foreach(function(a){var b=a.closed;a.line==c.row&&a.col==c.col?$RETURN(this._rowColToPosition(b.line,b.col+1)):b.line==c.row&&b.col==c.col-1&&$RETURN(this._rowColToPosition(a.line,a.col))},this)},indent_sexp:Ymacs_Interactive(function(){var a=this.cmd("matching_paren");a!=null?this.cmd("indent_region",this.point(),a):d(this)}),goto_matching_paren:Ymacs_Interactive(function(){var a=this.cmd("matching_paren");if(a!=null)return this.cmd("goto_char",a),!0}),forward_sexp:Ymacs_Interactive(function(){var a,b,f,g=this._rowcol,h=this.tokenizer.finishParsing();if(h){a=e(h).mergeSort(c),b=a.foreach(function(a){(a.line>g.row||a.line==g.row&&a.col>=g.col)&&$RETURN(a)});if(!b||!b.closed){d(this);return}return f=this._rowColToPosition(b.line,b.col),this._rowcol.row==b.line&&this._rowcol.col==b.col||!/\S/.test(this._bufferSubstring(null,f))?this.cmd("goto_char",this._rowColToPosition(b.closed.line,b.closed.col)+1):this.cmd("goto_char",f),!0}}),backward_sexp:Ymacs_Interactive(function(){var a,b,f=this._rowcol,g=this.tokenizer.finishParsing();if(g){a=e(g).grep("closed").map("closed").mergeSort(c),b=a.r_foreach(function(a){(a.line<f.row||a.line==f.row&&a.col<f.col)&&$RETURN(a)});if(!b){d(this);return}return this.cmd("goto_char",this._rowColToPosition(b.opened.line,b.opened.col)),!0}}),mark_sexp:Ymacs_Interactive("^r",function(a,b){this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",b),this.ensureTransientMark(),this.cmd("forward_sexp"),this.cmd("set_mark_command",this.point()),this.transientMarker.swap(this.caretMarker)}),this.ensureTransientMark()}),kill_sexp:Ymacs_Interactive(function(){this._killingAction(this.point(),this.cmd("save_excursion",function(){return this.cmd("forward_sexp"),this.point()}))}),transpose_sexps:Ymacs_Interactive(function(){var a=[];this.cmd("forward_sexp"),a.push(this.point()),this.cmd("backward_sexp"),a.push(this.point()),this.cmd("backward_sexp"),a.push(this.point()),this.cmd("forward_sexp"),a.push(this.point()),this.cmd("goto_char",this._swapAreas(a))}),paredit_wrap_round:Ymacs_Interactive("^",function(a,c){var d,e,f,g,h;a||(a="("),d=b[a],e=this.transientMarker?this.getRegion():this.cmd("save_excursion",function(){var a=this.point();return c||this.cmd("forward_sexp"),{begin:a,end:this.point()}}),f=this._bufferSubstring(e.begin,e.end),g=this.point()<e.end,typeof d!="string"&&(f=f.replace(d.backslash,function(a){return"\\"+a}),d=d.close),h=this.createMarker(e.end),this.cmd("save_excursion",function(){this._replaceText(e.begin,e.end,a+f+d)},g),this.cmd("forward_char",g?1:-1),this.clearTransientMark(),this.cmd("indent_region",e.begin,h.getPosition()),h.destroy()}),down_list:Ymacs_Interactive(function(){var a,b=this._rowcol,f=this.tokenizer.finishParsing();f&&(a={line:b.row,col:b.col},f=e(f).grep("closed").mergeSort(c).grep_first(function(b){return c(b,a)>=0}),f!=null?this.cmd("goto_char",this._rowColToPosition(f.line,f.col)+1):d(this))}),backward_up_list:Ymacs_Interactive(function(){var a,b=this._rowcol,f=this.tokenizer.finishParsing();f&&(a={line:b.row,col:b.col},f=e(f).grep("closed").mergeSort(c).grep_last(function(b){return c(b,a)<0&&c(b.closed,a)>=0}),f!=null?this.cmd("goto_char",this._rowColToPosition(f.line,f.col)):d(this))}),up_list:Ymacs_Interactive(function(){this.cmd("backward_up_list"),this.cmd("forward_sexp")})}),Ymacs_Buffer.newMode("paren_match_mode",function(){var a,b,c,d=Ymacs_Keymap_ParenMatch();return this.pushKeymap(d),a=!1,b=function(){a&&this.deleteOverlay("match-paren")}.clearingTimeout(500,this),c={beforeInteractiveCommand:function(){b.doItNow()},afterInteractiveCommand:function(){var c=this.tokenizer.getLastParser(),d=this._rowcol;c&&e(c).foreach(function(c){var e=c.closed;if(c.line==d.row&&c.col==d.col||e.line==d.row&&e.col==d.col-1)a=!0,this.setOverlay("match-paren",{line1:c.line,line2:e.line,col1:c.col,col2:e.col+1}),b()},this)}.clearingTimeout(100)},this.addEventListener(c),function(){b.doItNow(),this.popKeymap(d),this.removeEventListener(c)}})}),function(){function j(a){return d[a]}function k(a){return e[a]}function l(a){return a.toLowerCase()!=a.toUpperCase()||/^[-0-9!#$%&*+./:<=>?@\[\]\^_\{\}~]$/i.test(a)}function m(a){return l(a)}var a,b,c,d,e,f,g,h,i;Ymacs_Buffer.newCommands({lisp_open_paren:Ymacs_Interactive(function(a){a==null&&(a="("),a+=j(a),this.cmd("insert",a),this.cmd("backward_char")}),lisp_close_paren:Ymacs_Interactive(function(a){var b=RegExp("\\s*\\"+a,"ig");this.cmd("looking_at",b)&&this._deleteText(this.point(),this.matchData.after),this.cmd("insert",a)}),lisp_close_all_parens:Ymacs_Interactive(function(){var a,b=this.tokenizer.getParserForLine(this._rowcol.row);if(b){a=this.tokenizer.stream,a.line=this._rowcol.row,a.col=0;try{while(a.col<this._rowcol.col)b.next()}catch(c){}b=b.copy().context.parens,b.r_foreach(function(a){this.cmd("lisp_close_paren",j(a.type))},this)}})}),a="defvar defparameter deftype defstruct defclass defsetf destructuring-bind defmacro defun defmethod defgeneric defpackage in-package defreadtable in-readtable when cond unless etypecase typecase ctypecase lambda let load-time-value quote macrolet progn prog1 prog2 progv go flet the if throw eval-when multiple-value-prog1 unwind-protect let* ignore-errors handler-case handler-bind invoke-restart restart-case restart-bind case labels function symbol-macrolet block tagbody catch locally return return-from setq setf multiple-value-call".qw().toHash(),b="loop do while".qw().toHash(),c="t nil".qw().toHash(),d={"(":")","{":"}","[":"]"},e={")":"(","}":"{","]":"["},f="defun defmacro defgeneric defmethod".qw().toHash(),g="deftype defclass defstruct".qw().toHash(),h={"if":"3+",when:"1*",lambda:"1*",unless:"1*",defun:"2*",defpackage:"1*",defgeneric:"2*",defmethod:"2*",defclass:"2*",defmacro:"2*",progn:"0+",prog1:"1*",prog2:"2*",let:"1*",labels:"1*",flet:"1*",macrolet:"1*","destructuring-bind":"2*","unwind-protect":"1*","catch":"1*","case":"1*",ecase:"1*",cond:"0+","handler-bind":"1*","handler-case":"1*","restart-bind":"1*","restart-case":"1*","return-from":"1*",block:"1*"},i="labels flet macrolet".qw().toHash(),Ymacs_Tokenizer.define("lisp",function(d,e){function w(){function b(){return n=a.cont.slice(0),o=a.inString,q=a.quote,p=a.inComment,r=a.parens.slice(0),s=a.passedParens.slice(0),t=a.backList.slice(0),u=a.list.slice(0),v}var a=b.context={cont:n.slice(0),quote:q,inString:o,inComment:p,parens:r.slice(0),passedParens:s.slice(0),backList:t.slice(0),list:u.slice(0)};return b}function x(a,b,c){e.onToken(d.line,a,b,c)}function y(a){a==null&&(a={c1:d.col}),u.push(a)}function z(){return d.buffer.getq("indent_level")}function A(){var a=d.col,b=d.get(),c=b;while(!d.eol()){b=d.peek();if(!l(b))break;c+=b,d.nextCol()}return b&&{line:d.line,c1:a,c2:d.col,id:c.toLowerCase()}}function B(a,b){var c,e=!1,f=d.col;while(!d.eol()){c=d.peek();if(c===a&&!e)return n.pop(),o=null,x(f,d.col,b),x(d.col,++d.col,b+"-stopper"),!0;e=!e&&c==="\\",d.nextCol()}x(f,d.col,b)}function C(){var a=d.lineText(),b=a.indexOf("|#",d.col),c=/^\s*\|+/.exec(a.substr(d.col));c&&x(d.col,d.col+=c[0].length,"mcomment-starter"),b<0?(x(d.col,a.length,"mcomment"),d.col=a.length):(n.pop(),p=null,x(d.col,b,"mcomment"),x(b,b+=2,"mcomment-stopper"),d.col=b)}function D(a){var b=u&&u.length>0&&u[0].id;if(b)return b=b.toLowerCase(),a==null?b:typeof a=="string"?b==a:b in a}function E(){var e,h,i,l;d.checkStop();if(n.length>0)return n.peek()();e=d.peek(),(h=d.lookingAt(/^#\\.[a-z0-9_-]*/i))?(y(),x(d.col,d.col+=h[0].length,"constant")):(h=d.lookingAt(/^#\x2f((\\.|[^\x2f])*)\x2f([igsm]*)/))?(y(),x(d.col,d.col+=2,"regexp-starter"),x(d.col,d.col+=h[1].length,"regexp"),x(d.col,d.col+=1,"regexp-stopper"),h[3]&&x(d.col,d.col+=h[3].length,"regexp-modifier")):d.lookingAt(/^#\x27[^(]/)?(y(),d.col+=2,h=A(),x(h.c1,h.c2,"function-name")):d.lookingAt("#|")?(p={line:d.line,c1:d.col},x(d.col,d.col+=2,"mcomment-starter"),n.push(C)):(h=d.lookingAt(/^;+/))?(x(d.col,d.col+=h[0].length,"comment-starter"),x(d.col,d.col=d.lineLength(),"comment")):e==='"'?(y(),o={line:d.line,c1:d.col},x(d.col,++d.col,"string-starter"),n.push(B.$C(e,"string"))):(h=d.lookingAt(/^[+-]?(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*)(\x2f(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*))?/))?(y(),x(d.col
,d.col+=h[0].length,"number")):(h=j(e))?(y(),t.push(u),u=[],r.push({line:d.line,col:d.col,type:e}),x(d.col,++d.col,"open-paren")):(h=k(e))?(i=r.pop(),!i||i.type!=h?x(d.col,++d.col,"error"):(i.closed={line:d.line,col:d.col,opened:i},s.push(i),u=t.pop(),x(d.col,++d.col,"close-paren"))):m(e)&&(h=A())?(l=e==":"?"lisp-keyword":e=="&"?"type":/^#:/.test(h.id)?"constant":h.id in a?"keyword":h.id in b?"builtin":h.id in c?"constant":null,l||(D(f)&&u.length==1?l="function-name":D(g)&&u.length==1?l="type":/^with(out)?[-\x2f]|:with(out)?[-\x2f]/i.test(h.id)&&(l="builtin")),y(h),x(h.c1,h.c2,l)):x(d.col,++d.col,null)}function F(){var a,b,c,e,f,g,j,k,l,n,p=d.lineText();if(o)return Math.max(0,p.search(/[^\s\t\n]/));a=0,b=r.peek();if(b){c=d.lineText(b.line),a=b.col+1;if(/[\#\']/.test(c.charAt(b.col-1)))return a;m(c.charAt(a))&&(f=/\s\S/g,f.lastIndex=b.col,e=f.exec(c),e&&(a=e=e.index+1));if(u&&u.length){g=D();if(g){g=g.replace(/\*$/,""),j=h[g],!j&&/^with|:with/.test(g)&&(j="0*"),!j&&/^def/.test(g)&&(e&&/[\(\[\{]/.test(c.charAt(e))?j="1*":j="2*");if(!j)try{Object.HOP(i,t[t.length-2][0].id)&&(j="1*")}catch(q){}j&&(k=parseInt(j,10),l=/\+/.test(j),n=/\*/.test(j),a=b.col+z(),l&&e?a=e:k>0&&u.length-1<k&&(e?a=e:a+=z()))}}}return a}var n=[],o=!1,p=!1,q=null,r=[],s=[],t=[],u=[],v={next:E,copy:w,indentation:F};return v})}(),DEFINE_SINGLETON("Ymacs_Keymap_LispMode",Ymacs_Keymap,function(a){a.KEYS={"ENTER && C-j && C-m":"newline_and_indent","(":["lisp_open_paren","("],")":["lisp_close_paren",")"],"C-c ] && C-c C-]":"lisp_close_all_parens"}}),Ymacs_Buffer.newMode("lisp_mode",function(){var a,b,c,d=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"lisp"})),a=this.setq({indent_level:2}),b=Ymacs_Keymap_LispMode(),this.pushKeymap(b),c=this.cmd("paren_match_mode",!0),function(){this.setTokenizer(d),this.setq(a),this.popKeymap(b),c||this.cmd("paren_match_mode",!1)}}),function(){function i(a){return a.toLowerCase()!=a.toUpperCase()}function j(a){return a&&(i(a)||/^[_$]$/.test(a))}function k(a){return a&&(i(a)||/^[0-9_$]$/.test(a))}function l(b){return a[b]}function m(a){return b[a]}function n(b,c,d,e,f,g){function s(){return f.buffer.getq("indent_level")}function t(){function b(){return i=a.cont.slice(0),p=a.inComment,q=a.inString,n=a.parens.slice(0),o=a.passedParens.slice(0),r}var a=b.context={cont:i.slice(0),inComment:p,inString:q,parens:n.slice(0),passedParens:o.slice(0)};return b}function u(a,b,c){g.onToken(f.line,a,b,c)}function v(){var a=f.col,b=f.get(),c=b;while(!f.eol()){b=f.peek();if(!k(b))break;c+=b,f.nextCol()}return b&&{line:f.line,c1:a,c2:f.col,id:c}}function w(){var a=f.lineText(),b=a.indexOf("*/",f.col),c=/^\s*\*+/.exec(a.substr(f.col));c&&u(f.col,f.col+=c[0].length,"mcomment-starter"),b<0?(u(f.col,a.length,"mcomment"),f.col=a.length):(i.pop(),p=null,u(f.col,b,"mcomment"),u(b,b+=2,"mcomment-stopper"),f.col=b)}function x(a,b){var c,d=!1,e=f.col;while(!f.eol()){c=f.peek();if(c===a&&!d)return i.pop(),q=null,u(e,f.col,b),u(f.col,++f.col,b+"-stopper"),!0;d=!d&&c==="\\",f.nextCol()}u(e,f.col,b)}function y(){var a,b,c=!1,d=0,e=f.col;while(!f.eol()){a=f.peek(),l(a)&&!c&&!d&&d++,m(a)&&!c&&(d--,d<0&&(d=0));if(a==="/"&&!c&&!d)return i.pop(),q=null,u(e,f.col,"regexp"),u(f.col,++f.col,"regexp-stopper"),b=f.lookingAt(/^[gmsiy]+/),b&&u(f.col,f.col+=b[0].length,"regexp-modifier"),!0;c=!c&&a==="\\",f.nextCol()}u(e,f.col,"regexp")}function z(){var a,g,k,r,s;f.checkStop();if(i.length>0)return i.peek()();a=f.peek(),f.lookingAt("/*")?(p={line:f.line,c1:f.col},u(f.col,f.col+=2,"mcomment-starter"),i.push(w)):f.lookingAt("//")?(u(f.col,f.col+=2,"comment-starter"),u(f.col,f.col=f.lineLength(),"comment")):a==='"'||a==="'"?(q={line:f.line,c1:f.col},u(f.col,++f.col,"string-starter"),i.push(x.$C(a,"string"))):(g=f.lookingAt(/^0x[0-9a-f]+|^[0-9]*\.?[0-9]+/))?u(f.col,f.col+=g[0].length,"number"):j(a)&&(k=v())?(r=k.id in b?"keyword":k.id in c?"type":k.id in d?"constant":k.id in e?"builtin":null,u(k.c1,k.c2,r)):(k=l(a))?(n.push({line:f.line,col:f.col,type:a}),u(f.col,++f.col,"open-paren")):(k=m(a))?(s=n.pop(),!s||s.type!=k?u(f.col,++f.col,"error"):(s.closed={line:f.line,col:f.col,opened:s},o.push(s),u(f.col,++f.col,"close-paren"))):a==="/"&&h.test(f.textBefore())?(u(f.col,++f.col,"regexp-starter"),i.push(y)):(g=f.lookingAt(/^\s+$/))?u(f.col,f.col+=g[0].length,"trailing-whitespace"):u(f.col,++f.col,null)}function A(){var b,c,d,e,g,h,i,j,k,l,m;return q?0:(b=f.line,c=f.lineText(),d=0,p?(e=f.lineText(p.line),d=p.c1+1,/^\s*\*/.test(c)||(g=/[^\s*]/g,g.lastIndex=p.c1+1,h=g.exec(e),h&&(d=h.index)),d):(i=n.peek(),i&&(g=RegExp("^\\s*\\"+a[i.type]),j=g.test(c),k=f.lineText(i.line),g=/\S/g,g.lastIndex=i.col+1,h=g.exec(k),h?d=j?i.col:h.index:(d=f.lineIndentation(i.line)+s(),j&&(d-=s()))),b>0&&(l=f.textBefore(),/\)\s*$/.test(l)&&o.length>0?(i=o.peek(),m=f.lineText(i.line),/^\s*(if|for|while)\W/.test(m)&&(d+=s())):/\Welse\s*$/.test(l)&&(d+=s())),/^\s*(case|default)\W/.test(c)&&(d-=s()/2),d))}var i=[],n=[],o=[],p=null,q=null,r={next:z,copy:t,indentation:A};return r}var a,b,c,d="abstract break case catch class const continue debugger default delete do else enum export extends final finally for function goto if implements import in instanceof interface native new package private protected public return static super switch synchronized throw throws transient try typeof var void let yield volatile while with".qw(),e="boolean byte char double float int long short void Array Date Function Math Number Object RegExp String".qw(),f="false null undefined Infinity NaN true arguments this".qw(),g="Infinity NaN Packages decodeURI decodeURIComponent encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt undefined window document alert prototype constructor".qw(),h=/[\[({,;+\-*=?&|!:][\x20\t\n\xa0]*$|return\s+$|typeof\s+$/;a={"(":")","{":"}","[":"]"},b={")":"(","}":"{","]":"["},Ymacs_Tokenizer.define("js",n.$C(d.toHash(!0),e.toHash(!0),f.toHash(!0),g.toHash(!0))),c=g.concat("DEFINE_CLASS DEFINE_SINGLETON DEFINE_HIDDEN_CLASS DEFAULT_ARGS DEFAULT_EVENTS FIXARGS CONSTRUCT BEFORE_BASE FINISH_OBJECT_DEF D P $".qw()),Ymacs_Tokenizer.define("js-dynarchlib",n.$C(d.toHash(!0),e.toHash(!0),f.toHash(!0),c.toHash(!0)))}(),DEFINE_SINGLETON("Ymacs_Keymap_CLanguages",Ymacs_Keymap,function(a){a.KEYS={ENTER:"newline_and_indent","} && ) && ] && : && ; && { && ( && [ && *":"c_insert_and_indent"}}),Ymacs_Buffer.newMode("javascript_mode",function(a){var b,c=this.tokenizer,d=Ymacs_Keymap_CLanguages();return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:a?"js-dynarchlib":"js"})),this.pushKeymap(d),b=this.cmd("paren_match_mode",!0),function(){this.setTokenizer(c),this.popKeymap(d),b||this.cmd("paren_match_mode",!1)}}),Ymacs_Buffer.newCommands({javascript_dl_mode:Ymacs_Interactive(function(){return this.cmd("javascript_mode",!0)}),c_electric_block:Ymacs_Interactive(function(){this.cmd("indent_line"),this.cmd("insert","{\n\n}"),this.cmd("indent_line"),this.cmd("backward_line",1),this.cmd("indent_line")}),c_insert_and_indent:Ymacs_Interactive(function(){var a;if(a=this.cmd("self_insert_command"))return this.cmd("indent_line"),a})}),Ymacs_Tokenizer.define("xml",function(a,b){function h(){function j(){return d=b.slice(0),c=a.slice(0),e=h,f=i,g}var a=c.slice(0),b=d.slice(0),h=e,i=f;return j}function i(){return a.buffer.getq("indent_level")}function j(c,d,e){b.onToken(a.line,c,d,e)}function k(a){return a.toLowerCase()!=a.toUpperCase()}function l(a){return a&&(k(a)||/^[:_-]$/.test(a))}function m(a){return a&&(k(a)||/^[0-9_-]$/.test(a))}function n(){var b=a.col,c=a.get(),d=c;while(!a.eol()){c=a.peek();if(!m(c))break;d+=c,a.nextCol()}return c&&{line:a.line,c1:b,c2:a.col,id:d}}function o(b){var c,e=!1,f=a.col;while(!a.eol()){c=a.peek();if(c===b&&!e){d.pop(),j(f,a.col,"string"),j(a.col,++a.col,"string-stopper");return}e=!e&&c==="\\",a.nextCol()}j(f,a.col,"string")}function p(){var b,f=a.peek();a.lookingAt(/^\x2f>/)?(d.pop(),e=null,j(a.col,++a.col,"xml-closetag-slash"),j(a.col,++a.col,"xml-close-bracket")):f===">"?(d.pop(),c.push(e),e=null,j(a.col,++a.col,"xml-close-bracket")):l(f)&&(b=n())?j(b.c1,b.c2,"xml-attribute"):f==='"'||f==="'"?(j(a.col,++a.col,"string-starter"),d.push(o.$C(f))):j(a.col,++a.col,null)}function q(b,c){var e=a.lineText(),g=e.indexOf(c,a.col);g<0?(j(a.col,e.length,b),a.col=e.length):(d.pop(),j(a.col,g,b),f=null,j(g,g+=c.length,b+"-stopper"),a.col=g)}function r(){var b=a.lookingAt(/^([\s\xA0]*)(>?)/);b&&b[0]?(b[1]&&j(a.col,a.col+=b[1].length,null),b[2]&&(j(a.col,a.col+=b[2].length,"xml-close-bracket"),d.pop())):j(a.col,++a.col,"error")}function s(){var b,g,h,i;a.checkStop();if(d.length>0)return d.peek()();b=a.peek(),a.lookingAt("<![CDATA[")?(j(a.col,a.col+=9,"xml-cdata-starter"),f={line:a.line,c1:a.col},d.push(q.$C("xml-cdata","]]>"))):a.lookingAt("<!--")?(j(a.col,a.col+=4,"mcomment-starter"),f={line:a.line,c1:a.col},d.push(q.$C("mcomment","-->"))):a.lookingAt(/^<\x2f/)&&l(a.peek(2))?(j(a.col,++a.col,"xml-open-bracket"),j(a.col,++a.col,"xml-closetag-slash"),h=n(),i=c.pop(),j(h.c1,h.c2,i&&i.id==h.id?"xml-close-tag":"error"),d.push(r)):b==="<"&&l(a.peek(1))?(j(a.col,++a.col,"xml-open-bracket"),h=n(),j(h.c1,h.c2,"xml-open-tag"),e=h,d.push(p)):(g=a.lookingAt(/^&.*?;/))?(j(a.col,++a.col,"xml-entity-starter"),j(a.col,a.col+=g[0].length-2,"xml-entity"),j(a.col,++a.col,"xml-entity-stopper")):b==="&"?j(a.col,++a.col,"error"):j(a.col,++a.col,null)}function t(){var b,d;if(f)b=a.lineIndentation(f.line)+i();else if(e)b=e.c1+e.id.length+1;else if(d=c.peek())b=a.lineIndentation(d.line)+i(),/^\s*<\x2f/.test(a.lineText())&&(b-=i());return b}var c=[],d=[],e=null,f=null,g={next:s,copy:h,indentation:t};return g}),DEFINE_SINGLETON("Ymacs_Keymap_XML",Ymacs_Keymap,function(a){a.KEYS={"C-c /":"xml_close_tag","C-ENTER":"xml_zen_expand",ENTER:"newline_and_indent"}}),Ymacs_Buffer.newMode("xml_mode",function(){var a,b,c=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"xml"})),a=Ymacs_Keymap_XML(),this.pushKeymap(a),b=this.setq({indent_level:2}),function(){this.setTokenizer(c),this.popKeymap(a),this.setq(b)}}),function(){function f(a,b){var c,d=a.repeat||1;for(c=1;c<=d;++c)c>1&&b("\n"),b("<",a.type),a.id&&b(' id="',a.id.replace(/\$/g,c),'"'),a.klass&&b(' class="',a.klass.replace(/\$/g,c),'"'),a.attributes&&a.attributes.foreach(function(a){b(" ",a,'="|"')}),b(">"),a.child?(b("\n"),f(a.child,b),b("\n")):b("|"),b("</",a.type,">"),a.next&&(b("\n"),f(a.next,b))}function g(f,h){var i,j={type:""},k=a;a:while(h<f.length){i=f.charAt(h++);switch(i){case"#":k=c,j.id="";break;case".":k=b,j.klass!=null?j.klass+=" ":j.klass="";break;case":":k=e,j.attributes==null&&(j.attributes=[]),j.attributes.push("");break;case"*":k=d,j.repeat="";break;case">":j.child=g(f,h),h=j.child.i;break a;case"(":j.child=g(f,h),h=j.child.i;break;case")":break a;case"+":j.next=g(f,h),h=j.next.i;break a;default:switch(k){case a:j.type+=i;break;case b:j.klass+=i;break;case c:j.id+=i;break;case d:j.repeat=parseInt(j.repeat+""+i,10);break;case e:j.attributes.push(j.attributes.pop()+i)}}}return j.i=h,j}function h(){var a=this.point(),b=this.getq("xml_zen_markers"),c=b[0],d=b.peek();(a<c.getPosition()||a>d.getPosition()||d.getPosition()==b.peek(1).getPosition())&&this.cmd("xml_zen_stop")}var a,b,c,d,e;DEFINE_SINGLETON("Ymacs_Keymap_XML_Zen",Ymacs_Keymap,function(a){a.KEYS={TAB:"xml_zen_next_poi","S-TAB":"xml_zen_prev_poi","C-g":"xml_zen_stop"}}),a=1,b=2,c=3,d=4,e=5,Ymacs_Buffer.newCommands({xml_close_tag:Ymacs_Interactive(function(){this.cmd("close_last_xml_tag"),this.cmd("indent_line")}),xml_zen_expand:Ymacs_Interactive(function(){var a,b,c,d,e,i;this.cmd("xml_zen_stop"),a=String.buffer(),b=this.cmd("save_excursion",function(){this.cmd("backward_whitespace");while(!this.cmd("looking_back",/[\x20\xa0\s\t\n;&]/))if(!this.cmd("backward_char"))break;return this.point()}),c=this.point();try{f(g(this.cmd("buffer_substring",b,c).trim(),0),a)}catch(j){throw new Ymacs_Exception("The Zen is not strong today :-/")}a=a.get(),this.cmd("delete_region",b,c),this.cmd("insert",a),b=this.createMarker(b,!1,"xml_zen"),d=this.createMarker(this.point(),!0,"xml_zen"),e=[],this.cmd("goto_char",b.getPosition());while(this.cmd("search_forward","|",d.getPosition()))this.cmd("backward_delete_char"),e.push(this.createMarker(this.point(),!0,"xml_zen_start")),e.push(this.createMarker(this.point(),!1,"xml_zen_end"));this.cmd("indent_region",b.getPosition(),d.getPosition()),i=e.length,i>0?(this.cmd("goto_char",e[0]),e.unshift(b),e.push(d),this.setq("xml_zen_markers",e),this.pushKeymap(Ymacs_Keymap_XML_Zen()),this.addEventListener("afterInteractiveCommand",h)):(b.destroy(),d.destroy())}),xml_zen_stop:Ymacs_Interactive(function(){var a=this.getq("xml_zen_markers");a&&(a.map("destroy"),this.setq("xml_zen_markers",null)),this.popKeymap(Ymacs_Keymap_XML_Zen()),this.removeEventListener("afterInteractiveCommand",h)}),xml_zen_next_poi:Ymacs_Interactive(function(){var a=this.getq("xml_zen_markers"),b=this.point();a.foreach(function(a){a.getPosition()>b&&(this.cmd("goto_char",a.getPosition()),$BREAK())},this)}),xml_zen_prev_poi:Ymacs_Interactive(function(){var a=this.getq("xml_zen_markers"),b=this.point();a.r_foreach(function(a){a.getPosition()<b&&(this.cmd("goto_char",a.getPosition()),$BREAK())},this)})})}(),Ymacs_Tokenizer.define("css",function(a,b){function k(){function b(){return f=a.parens.slice(0),g=a.passedParens.slice(0),h=a.cont.slice(0),i=a.inString,j=a.inComment,e}var a=b.context={parens:f.slice(0),passedParens:g.slice(0),cont:h.slice(0),inString:i,inComment:j};return b}function l(){return b.buffer.getq("indent_level")}function m(a){return c[a]}function n(a){return d[a]}function o(c,d,e){b.onToken(a.line,c,d,e)}function p(){var b=a.lineText(),c=b.indexOf("*/",a.col),d=/^\s*\*+/.exec(b.substr(a.col));d&&o(a.col,a.col+=d[0].length,"mcomment-starter"),c<0?(o(a.col,b.length,"mcomment"),a.col=b.length):(h.pop(),j=null,o(a.col,c,"mcomment"),o(c,c+=2,"mcomment-stopper"),a.col=c)}function q(b,c){var d,e=!1,f=a.col;while(!a.eol()){d=a.peek();if(d===b&&!e)return h.pop(),i=null,o(f,a.col,c),o(a.col,++a.col,c+"-stopper"),!0;e=!e&&d==="\\",a.nextCol()}o(f,a.col,c)}function r(){var b,c,d;a.checkStop();if(h.length>0)return h.peek()();b=a.peek(),a.lookingAt("/*")?(j={line:a.line,c1:a.col},o(a.col,a.col+=2,"mcomment-starter"),h.push(p)):b==='"'||b==="'"?(i={line:a.line,c1:a.col},o(a.col,++a.col,"string-starter"),h.push(q.$C(b,"string"))):(c=m(b))?(f.push({line:a.line,col:a.col,type:b}),o(a.col,++a.col,"open-paren")):(c=n(b))?(d=f.pop(),!d||d.type!=c?o(a.col,++a.col,"error"):(d.closed={line:a.line,col:a.col,opened:d},g.push(d),o(a.col,++a.col,"close-paren"))):(c=a.lookingAt(/^([a-zA-z-]+):/))?(o(a.col,a.col+=c[1].length,"keyword"),o(a.col,++a.col,"operator")):(c=a.lookingAt(/^([0-9.]+)(px|pt|em|ex|in|cm|mm|%)/))?(o(a.col,a.col+=c[1].length,"number"),o(a.col,a.col+=c[2].length,"type")):(c=a.lookingAt(/^(\.[a-zA-Z0-9_:-]+)/))?o(a.col,a.col+=c[1].length,"function-name"):(c=a.lookingAt(/^(#[a-zA-Z0-9_:-]+)/))?o(a.col,a.col+=c[1].length,"constant"):(c=a.lookingAt(/^(@[a-zA-Z0-9_:-]+)/))?o(a.col,a.col+=c[1].length,"builtin"):(c=a.lookingAt(/^(url|none|auto|bold|italic|normal|inherit|print|screen|all)/))?o(a.col,a.col+=c[1].length,"builtin"):o(a.col,++a.col,null)}function s(){var b,d,e,g,h,k,m,n,o;return i?0:(b=a.line,d=a.lineText(),e=0,j?(g=a.lineText(j.line),e=j.c1+1,/^\s*\*/.test(d)||(h=/[^\s*]/g,h.lastIndex=j.c1+1,k=h.exec(g),k&&(e=k.index)),e):(m=f.peek(),m&&(h=RegExp("^\\s*\\"+c[m.type]),n=h.test(d),o=a.lineText(m.line),h=/\S/g,h.lastIndex=m.col+1,k=h.exec(o),k?e=n?m.col:k.index:(e=a.lineIndentation(m.line)+l(),n&&(e-=l()))),e))}var c,d,e={next:r,copy:k,indentation:s},f=[],g=[],h=[],i=null,j=null;return c={"(":")","{":"}","[":"]"},d={")":"(","}":"{","]":"["},e}),DEFINE_SINGLETON("Ymacs_Keymap_CSS",Ymacs_Keymap),Ymacs_Keymap_CSS().defineKeys({ENTER:"newline_and_indent",": && } && )":"c_insert_and_indent"}),Ymacs_Buffer.newMode("css_mode",function(){var a,b=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"css"})),a=this.cmd("paren_match_mode",!0),this.pushKeymap(Ymacs_Keymap_CSS()),function(){this.setTokenizer(b),a||this.cmd("paren_match_mode",!1),this.popKeymap(Ymacs_Keymap_CSS())}}),Ymacs_Tokenizer.define("markdown",function(a,b){function d(){function b(){return c}var a=b.context={};return b}function e(c,d,e){b.onToken(a.line,c,d,e)}function f(){var c;a.checkStop(),a.col==0&&(c=a.lookingAt(/^(#+)/))?e(0,a.col=a.lineLength(),"markdown-heading"+c[0].length):a.line>0&&a.col==0&&(c=a.lookingAt(/^[=-]+$/))&&/\S/.test(a.lineText(a.line-1))?(c=c[0].charAt(0)=="="?1:2,c="markdown-heading"+c,b.onToken(a.line-1,0,a.lineLength(a.line-1),c),e(0,a.col=a.lineLength(),c)):a.col==0&&(c=a.lookingAt(/^[>\s]*/))?(c=c[0].replace(/\s+/g,"").length,c>3&&(c=""),c="markdown-blockquote"+c,e(0,a.col=a.lineLength(),c)):e(a.col,++a.col,null)}var c={next:f,copy:d};return c}),Ymacs_Buffer.newMode("markdown_mode",function(){var a=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"markdown"})),function(){this.setTokenizer(a)}});